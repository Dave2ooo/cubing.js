"use strict";var e=require("./index-3df29a49.js"),t=require("three"),r=require("./index-3d2ac941.js");
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
function i(e,t,r,i){return new(r||(r=Promise))((function(n,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function s(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){e.done?n(e.value):new r((function(t){t(e.value)})).then(a,s)}c((i=i.apply(e,t||[])).next())}))}function n(e){switch(Math.max(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z))){case e.x:return"x";case-e.x:return"-x";case e.y:return"y";case-e.y:return"-y";case e.z:return"z";case-e.z:return"-z";default:throw new Error("Uh-oh.")}}const o=Math.sqrt(.5),a={"y z":new t.Quaternion(0,0,0,1),"-z y":new t.Quaternion(o,0,0,o),"x z":new t.Quaternion(0,0,-o,o),"-x z":new t.Quaternion(0,0,o,o)};class BasicRotationTransformer{transformMove(e){}transformOrientation(e){const{x:r,y:i,z:o,w:s}=e.quaternion,c=new t.Quaternion(r,i,o,s),u=new t.Vector3(0,1,0),l=new t.Vector3(0,0,1),h=n(u.applyQuaternion(c)),d=n(l.applyQuaternion(c)),f=a[`${h} ${d}`]||a["y z"];console.log(c),console.log(f);const v=c.premultiply(f);console.log(v),e.quaternion={x:v.x,y:v.y,z:v.z,w:v.w},console.log(e.quaternion)}}class MoveEvent{}class BluetoothPuzzle{constructor(){this.transformers=[],this.listeners=[],this.orientationListeners=[]}getState(){return i(this,void 0,void 0,(function*(){throw new Error("cannot get state")}))}addMoveListener(e){this.listeners.push(e)}addOrientationListener(e){this.orientationListeners.push(e)}experimentalAddBasicRotationTransformer(){this.transformers.push(new BasicRotationTransformer)}dispatchMove(e){for(const t of this.transformers)t.transformMove(e);for(const t of this.listeners)t(e)}dispatchOrientation(e){for(const t of this.transformers)t.transformOrientation(e);for(const t of this.orientationListeners)t(e)}}let s=!0;function c(e){s=e}function u(...e){s&&(console.info?console.info.apply(console,e):console.log.apply(console,e))}const l=new Uint8Array(16),h=new Uint8Array(new Array(16).fill(16));function d(e,t){return i(this,void 0,void 0,(function*(){const r=yield function(e,t,r){return i(this,void 0,void 0,(function*(){return(yield window.crypto.subtle.encrypt({name:"AES-CBC",iv:r},e,t)).slice(0,16)}))}(e,h,t),n=new Uint8Array(32);return n.set(new Uint8Array(t),0),n.set(new Uint8Array(r),16),(yield window.crypto.subtle.decrypt({name:"AES-CBC",iv:l},e,n)).slice(0,16)}))}const f={0:e.BareBlockMove("U"),2:e.BareBlockMove("U",-1),3:e.BareBlockMove("R"),5:e.BareBlockMove("R",-1),6:e.BareBlockMove("F"),8:e.BareBlockMove("F",-1),9:e.BareBlockMove("D"),11:e.BareBlockMove("D",-1),12:e.BareBlockMove("L"),14:e.BareBlockMove("L",-1),15:e.BareBlockMove("B"),17:e.BareBlockMove("B",-1)};let v=null,p=(e,t,r)=>[-t,r,-e];function y(e){return e[13]<18&&e[14]<18&&e[15]<18&&e[16]<18&&e[17]<18&&e[18]<18}window.setSwap=e=>{p=e,v=null};const w=new Uint8Array([198,202,21,223,79,110,19,182,119,13,230,89,58,175,186,162]);new Uint8Array([67,226,91,214,125,220,120,216,7,96,163,218,130,60,1,241]);function m(e,t,r){return i(this,void 0,void 0,(function*(){const t=new Uint8Array(w);for(let e=0;e<r.length;e++)t[e]=(t[e]+r[e])%256;const n=yield function(e){return i(this,void 0,void 0,(function*(){return yield crypto.subtle.importKey("raw",e,"AES-CBC",!0,["encrypt","decrypt"])}))}(new Uint8Array(t));return e.set(new Uint8Array(yield d(n,e.slice(3))),3),e.set(new Uint8Array(yield d(n,e.slice(0,16))),0),e}))}function b(e,t){return i(this,void 0,void 0,(function*(){if(y(e))return e;const r=yield m(e,0,t);if(y(r))return r;const i=yield m(e,0,t);if(y(i))return i;throw new Error("Unable to decode")}))}class PhysicalState{constructor(e,t){if(this.dataView=e,this.timeStamp=t,this.arrLen=19,this.arr=new Uint8Array(e.buffer),this.arr.length!==this.arrLen)throw new Error("Unexpected array length")}static read(e,t){return i(this,void 0,void 0,(function*(){const r=yield b(new Uint8Array((yield e.readValue()).buffer),t),i=Date.now();return new PhysicalState(new DataView(r.buffer),i)}))}rotQuat(){let e=this.dataView.getInt16(0,!0)/16384,r=this.dataView.getInt16(2,!0)/16384,i=this.dataView.getInt16(4,!0)/16384;[e,r,i]=p(e,r,i);const n=1-(e*e+r*r+i*i),o=n>0?Math.sqrt(n):0,a=new t.Quaternion(e,r,i,o);return v||(v=a.clone().inverse()),a.clone().multiply(v.clone())}moveCounter(){return this.arr[12]}numMovesSince(e){return this.moveCounter()-e&255}latestMoves(e){if(e<0||e>6)throw new Error(`Must ask for 0 to 6 latest moves. (Asked for ${e})`);return Array.from(this.arr.slice(19-e,19)).map(e=>f[e])}debugInfo(){return{arr:this.arr}}}const g="0000fff0-0000-1000-8000-00805f9b34fb",C="0000fff5-0000-1000-8000-00805f9b34fb",B="0000fff7-0000-1000-8000-00805f9b34fb",z="0000fff2-0000-1000-8000-00805f9b34fb",S="0000fff3-0000-1000-8000-00805f9b34fb",A={reset:new Uint8Array([0,0,36,0,73,146,36,73,109,146,219,182,73,146,182,36,109,219])},M={filters:[{namePrefix:"GAN"}],optionalServices:[g]};const E="UF UR UB UL DF DR DB DL FR FL BR BL".split(" "),R="UFR URB UBL ULF DRF DFL DLB DBR".split(" ");function x(e,t){return e.slice(t)+e.slice(0,t)}const U={};E.forEach((e,t)=>{for(let r=0;r<2;r++)U[x(e,r)]={piece:t,orientation:r}}),R.forEach((e,t)=>{for(let r=0;r<3;r++)U[x(e,r)]={piece:t,orientation:r}});const k=[[0,21,15],[5,13,47],[7,45,39],[2,37,23],[29,10,16],[31,18,32],[26,34,40],[24,42,8]],D=[[1,22],[3,14],[6,46],[4,38],[30,17],[27,9],[25,41],[28,33],[19,12],[20,35],[44,11],[43,36]];class GanCube extends BluetoothPuzzle{constructor(e,t,i,n,o){super(),this.service=e,this.server=t,this.physicalStateCharacteristic=i,this.lastMoveCounter=n,this.macAddress=o,this.INTERVAL_MS=150,this.intervalHandle=null,this.kpuzzle=new r.KPuzzle(r.Puzzles["3x3x3"]),this.startTrackingMoves()}static connect(e){return i(this,void 0,void 0,(function*(){const t=function(e){const t=new Uint8Array([76,36,152,0,0,0]);return 10===e.length&&e.startsWith("GAN-")||console.warn("Unexpected puzzle name."),t[3]=parseInt(e.slice(4,6),16),t[4]=parseInt(e.slice(6,8),16),t[5]=parseInt(e.slice(8,10),16),t}(e.device.name),r=yield e.getPrimaryService(g);u("Service:",r);const i=yield r.getCharacteristic(C);u("Characteristic:",i);const n=(yield PhysicalState.read(i,t)).moveCounter();return u("Initial Move Counter:",n),new GanCube(r,e,i,n,t)}))}name(){return this.server.device.name}startTrackingMoves(){this.intervalHandle=window.setInterval(this.intervalHandler.bind(this),this.INTERVAL_MS)}stopTrackingMoves(){if(!this.intervalHandle)throw new Error("Not tracking moves!");clearInterval(this.intervalHandle),this.intervalHandle=null}intervalHandler(){return i(this,void 0,void 0,(function*(){const e=yield PhysicalState.read(this.physicalStateCharacteristic,this.macAddress);let t=e.numMovesSince(this.lastMoveCounter);t>6&&(u(`Too many moves! Dropping ${t-6} moves`),t=6);for(const r of e.latestMoves(t))this.kpuzzle.applyBlockMove(r),this.dispatchMove({latestMove:r,timeStamp:e.timeStamp,debug:e.debugInfo(),state:this.kpuzzle.state});const{x:r,y:i,z:n,w:o}=e.rotQuat();this.dispatchOrientation({timeStamp:e.timeStamp,quaternion:{x:r,y:i,z:n,w:o}}),this.lastMoveCounter=e.moveCounter()}))}getBattery(){return i(this,void 0,void 0,(function*(){return new Uint8Array(yield this.readActualAngleAndBatteryCharacteristic())[7]}))}getState(){return i(this,void 0,void 0,(function*(){const e=yield b(new Uint8Array(yield this.readFaceletStatus1Characteristic()),this.macAddress),t=[];for(let r=0;r<18;r+=3){let i=((e[1^r]<<8)+e[r+1^1]<<8)+e[r+2^1];for(let e=0;e<8;e++)t.push(7&i),i>>=3}const r={CORNER:{permutation:[],orientation:[]},EDGE:{permutation:[],orientation:[]},CENTER:{permutation:[0,1,2,3,4,5],orientation:[0,0,0,0,0,0]}};for(const e of k){const i=U[e.map(e=>"URFDLB"[t[e]]).join("")];r.CORNER.permutation.push(i.piece),r.CORNER.orientation.push(i.orientation)}for(const e of D){const i=U[e.map(e=>"URFDLB"[t[e]]).join("")];r.EDGE.permutation.push(i.piece),r.EDGE.orientation.push(i.orientation)}return r}))}faceletStatus1Characteristic(){return i(this,void 0,void 0,(function*(){return this.cachedFaceletStatus1Characteristic=this.cachedFaceletStatus1Characteristic||this.service.getCharacteristic(z),this.cachedFaceletStatus1Characteristic}))}faceletStatus2Characteristic(){return i(this,void 0,void 0,(function*(){return this.cachedFaceletStatus2Characteristic=this.cachedFaceletStatus2Characteristic||this.service.getCharacteristic(S),this.cachedFaceletStatus2Characteristic}))}actualAngleAndBatteryCharacteristic(){return i(this,void 0,void 0,(function*(){return this.cachedActualAngleAndBatteryCharacteristic=this.cachedActualAngleAndBatteryCharacteristic||this.service.getCharacteristic(B),this.cachedActualAngleAndBatteryCharacteristic}))}reset(){return i(this,void 0,void 0,(function*(){const e=yield this.faceletStatus1Characteristic();yield e.writeValue(A.reset)}))}readFaceletStatus1Characteristic(){return i(this,void 0,void 0,(function*(){const e=yield this.faceletStatus1Characteristic();return(yield e.readValue()).buffer}))}readFaceletStatus2Characteristic(){return i(this,void 0,void 0,(function*(){const e=yield this.faceletStatus2Characteristic();return t=(yield e.readValue()).buffer,Array.prototype.map.call(new Uint8Array(t),e=>("00"+e.toString(16)).slice(-2)).join(" ");var t}))}readActualAngleAndBatteryCharacteristic(){return i(this,void 0,void 0,(function*(){const e=yield this.actualAngleAndBatteryCharacteristic();return(yield e.readValue()).buffer}))}}const G="0000aadb-0000-1000-8000-00805f9b34fb",L="0000aadc-0000-1000-8000-00805f9b34fb",P={filters:[{namePrefix:"Gi"},{services:["0000aadb-0000-1000-8000-00805f9b34fb"]},{services:["0000aaaa-0000-1000-8000-00805f9b34fb"]},{services:["0000fe95-0000-1000-8000-00805f9b34fb"]}],optionalServices:[G]};function Q(t,r){9===r&&(u("Encountered 9",t,r),r=2),r=[0,1,2,-1][r];const i=["?","B","D","L","U","R","F"][t];return e.BareBlockMove(i,r)}const K={permutation:[0,1,2,3,4,5],orientation:[0,0,0,0,0,0]},F=[4,8,0,9,5,1,3,7,6,10,2,11],T=[2,5,10,6,0,4,8,7,1,3,9,11],V=[1,0,1,0,1,0,1,0,0,0,0,0],I=[1,0,1,0,1,0,1,0,0,0,0,0],O=[4,0,3,5,7,1,2,6],N=[1,5,6,2,0,3,7,4],q=[1,2,1,2,2,1,2,1],j=[2,1,2,1,1,2,1,2],H=[-1,1,-1,1,1,-1,1,-1];function _(e,t){return t%2==1?e[t/2|0]%16:0|e[t/2|0]/16}const $=[176,81,104,224,86,137,237,119,38,26,193,161,210,126,150,81,93,13,236,249,89,235,88,24,113,81,214,131,130,199,2,169,39,165,171,41];function W(e){return i(this,void 0,void 0,(function*(){return function(e){return 167===e[18]}(e)?yield function(e){const t=_(e,38),r=_(e,39),i=new Uint8Array(20);for(let n=0;n<20;n++)i[n]=e[n]+$[t+n]+$[r+n];return i}(e):e}))}class GiiKERCube extends BluetoothPuzzle{constructor(e,t,r){super(),this.server=e,this.cubeCharacteristic=t,this.originalValue=r}static connect(e){return i(this,void 0,void 0,(function*(){const t=yield e.getPrimaryService(G);u("Service:",t);const r=yield t.getCharacteristic(L);u("Characteristic:",r);const i=yield W(new Uint8Array((yield r.readValue()).buffer));u("Original value:",i);const n=new GiiKERCube(e,r,i);return yield r.startNotifications(),r.addEventListener("characteristicvaluechanged",n.onCubeCharacteristicChanged.bind(n)),n}))}name(){return this.server.device.name}getState(){return i(this,void 0,void 0,(function*(){return this.toReid333(new Uint8Array((yield this.cubeCharacteristic.readValue()).buffer))}))}getBit(e,t){const r=7-t%8;return e[t/8|0]>>r&1}toReid333(e){const t={EDGE:{permutation:new Array(12),orientation:new Array(12)},CORNER:{permutation:new Array(8),orientation:new Array(8)},CENTER:K};for(let r=0;r<12;r++){const i=T[r];t.EDGE.permutation[r]=F[_(e,i+16)-1],t.EDGE.orientation[r]=this.getBit(e,i+112)^V[t.EDGE.permutation[r]]^I[r]}for(let r=0;r<8;r++){const i=N[r];t.CORNER.permutation[r]=O[_(e,i)-1],t.CORNER.orientation[r]=(_(e,i+8)*H[i]+q[t.CORNER.permutation[r]]+j[r])%3}return t}onCubeCharacteristicChanged(e){return i(this,void 0,void 0,(function*(){const t=yield W(new Uint8Array(e.target.value.buffer));if(u(t),u(t),this.isRepeatedInitialValue(t))return void u("Skipping repeated initial value.");const r=[];for(let e=0;e<20;e++)r.push(Math.floor(t[e]/16)),r.push(t[e]%16);u(r);const i=function(e){let t="";return t+=e.slice(0,8).join("."),t+="\n",t+=e.slice(8,16).join("."),t+="\n",t+=e.slice(16,28).join("."),t+="\n",t+=e.slice(28,32).join("."),t+="\n",t+=e.slice(32,40).join("."),t}(r);u(i),this.dispatchMove({latestMove:Q(r[32],r[33]),timeStamp:e.timeStamp,debug:{stateStr:i},state:this.toReid333(t)})}))}isRepeatedInitialValue(e){if(void 0===this.originalValue)throw new Error("GiiKERCube has uninitialized original value.");if(null===this.originalValue)return!1;const t=this.originalValue;this.originalValue=null,u("Comparing against original value.");for(let r=0;r<18;r++)if(t[r]!==e[r])return u("Different at index ",r),!1;return!0}}const J="6e400001-b5a3-f393-e0a9-e50e24dcca9e",X="6e400003-b5a3-f393-e0a9-e50e24dcca9e",Y={filters:[{namePrefix:"GoCube"}],optionalServices:[J]};function Z(e){return Array.prototype.map.call(new Uint8Array(e),e=>("00"+e.toString(16)).slice(-2)).join("")}const ee=[e.BareBlockMove("B",1),e.BareBlockMove("B",-1),e.BareBlockMove("F",1),e.BareBlockMove("F",-1),e.BareBlockMove("U",1),e.BareBlockMove("U",-1),e.BareBlockMove("D",1),e.BareBlockMove("D",-1),e.BareBlockMove("R",1),e.BareBlockMove("R",-1),e.BareBlockMove("L",1),e.BareBlockMove("L",-1)];class GoCube extends BluetoothPuzzle{constructor(r,i){super(),this.server=r,this.goCubeStateCharacteristic=i,this.recorded=[],this.homeQuatInverse=null,this.lastRawQuat=new t.Quaternion(0,0,0,1),this.currentQuat=new t.Quaternion(0,0,0,1),this.lastTarget=new t.Quaternion(0,0,0,1),this.alg=new e.Sequence([])}static connect(e){return i(this,void 0,void 0,(function*(){const t=yield e.getPrimaryService(J);u({service:t});const r=yield t.getCharacteristic(X);u({goCubeStateCharacteristic:r});const i=new GoCube(e,r);return yield r.startNotifications(),r.addEventListener("characteristicvaluechanged",i.onCubeCharacteristicChanged.bind(i)),i}))}reset(){this.resetAlg(),this.resetOrientation()}resetAlg(t){this.alg=t||new e.Sequence([])}resetOrientation(){this.homeQuatInverse=this.lastRawQuat.clone().inverse(),this.currentQuat=new t.Quaternion(0,0,0,1),this.lastTarget=new t.Quaternion(0,0,0,1)}name(){return this.server.device.name}onCubeCharacteristicChanged(r){const i=r.target.value;if(this.recorded.push([r.timeStamp,Z(i.buffer)]),8===i.byteLength){const t=ee[i.getUint8(3)];this.alg=new e.Sequence(this.alg.nestedUnits.concat([t])),this.dispatchMove({latestMove:ee[i.getUint8(3)],timeStamp:r.timeStamp,debug:{stateStr:Z(i.buffer)}})}else{const e=function(e){const t=new Uint8Array(e);let r="";for(const e of t)r+=String.fromCharCode(e);return r}(i.buffer.slice(3,i.byteLength-3)).split("#").map(e=>parseInt(e,10)/16384),n=new t.Quaternion(e[0],e[1],e[2],e[3]);this.lastRawQuat=n.clone(),this.homeQuatInverse||(this.homeQuatInverse=n.clone().inverse());const o=n.clone().multiply(this.homeQuatInverse.clone());o.y=-o.y,this.lastTarget.slerp(o,.5),this.currentQuat.rotateTowards(this.lastTarget,te);const{x:a,y:s,z:c,w:u}=this.currentQuat;this.dispatchOrientation({quaternion:{x:a,y:s,z:c,w:u},timeStamp:r.timeStamp})}}}const te=.5,re=r.Puzzles["3x3x3"];class KeyboardPuzzle extends BluetoothPuzzle{constructor(e){super(),this.puzzle=new r.KPuzzle(re),e.addEventListener("keydown",this.onKeyDown.bind(this))}name(){return"Keyboard Input"}getState(){return i(this,void 0,void 0,(function*(){return this.puzzle.state}))}onKeyDown(t){if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return;const r=e.keyToMove(t);r&&(this.puzzle.applyBlockMove(r),this.dispatchMove({latestMove:r,timeStamp:t.timeStamp,state:this.puzzle.state}),t.preventDefault())}}function ie(e=window){return i(this,void 0,void 0,(function*(){return new KeyboardPuzzle(e)}))}let ne=0;function oe(e={}){return i(this,void 0,void 0,(function*(){let t;u("Attempting to pair.");try{let r=e.acceptAllDevices;!r&&ne>=2&&(console.info("The last 2 Bluetooth puzzle connection attempts failed. This time, the Bluetooth prompt will show all possible devices."),r=!0),t=yield navigator.bluetooth.requestDevice(function(e=!1){const t=e?{acceptAllDevices:!0,optionalServices:[]}:{filters:[],optionalServices:[]};for(const r of[M,P,Y])e||(t.filters=t.filters.concat(r.filters)),t.optionalServices=t.optionalServices.concat(r.optionalServices);return u({requestOptions:t}),t}(r)),ne=0}catch(e){throw ne++,new Error(e)}if(u("Device:",t),void 0===t.gatt)return Promise.reject("Device did not have a GATT server.");const r=yield t.gatt.connect();u("Server:",r);const i=r.device.name||"";return i&&i.startsWith("GAN")?yield GanCube.connect(r):i&&i.startsWith("GoCube")?yield GoCube.connect(r):yield GiiKERCube.connect(r)}))}var ae=Object.freeze({__proto__:null,GanCube:GanCube,GiiKERCube:GiiKERCube,giikerMoveToBlockMoveForTesting:Q,GoCube:GoCube,BluetoothPuzzle:BluetoothPuzzle,MoveEvent:MoveEvent,KeyboardPuzzle:KeyboardPuzzle,debugKeyboardConnect:ie,enableDebugLogging:c,connect:oe});exports.BluetoothPuzzle=BluetoothPuzzle,exports.GanCube=GanCube,exports.GiiKERCube=GiiKERCube,exports.GoCube=GoCube,exports.KeyboardPuzzle=KeyboardPuzzle,exports.MoveEvent=MoveEvent,exports.connect=oe,exports.debugKeyboardConnect=ie,exports.enableDebugLogging=c,exports.giikerMoveToBlockMove=Q,exports.index=ae;
//# sourceMappingURL=index-25757155.js.map
