!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three"),require("fs")):"function"==typeof define&&define.amd?define(["exports","three","fs"],t):t((e=e||self).cubing={},e.three,e.fs)}(this,(function(e,t,n){"use strict";let r="warn";let i=0;function o(e){switch(r){case"error":throw new Error(e);case"warn":return i++,void(i<10&&i+1===10&&console.warn(e))}}class AlgPart{}function s(e,t){return e.type===t}function a(e,t){return s(e,t)||o(`Expected "type": "${t}", saw "type": "${e.type}".`),e}function l(e){return"type"in e&&!s(e,"sequence")}function u(e){return"type"in e||o('Expected "unit", saw a value that was not an AlgPart.'),s(e,"sequence")&&o('Expected unit, saw "sequence".'),e}class Unit extends AlgPart{}class Move extends Unit{}class Annotation extends Unit{}class Container extends Unit{}class Sequence extends AlgPart{constructor(e){super(),this.nestedUnits=e,this.type="sequence";for(const t of e)u(t);Object.freeze(this.nestedUnits),Object.freeze(this)}}class Group extends Container{constructor(e,t=1){super(),this.nestedSequence=e,this.amount=t,this.type="group",Object.freeze(this)}}class Commutator extends Container{constructor(e,t,n=1){super(),this.A=e,this.B=t,this.amount=n,this.type="commutator",Object.freeze(this)}}class Conjugate extends Container{constructor(e,t,n=1){super(),this.A=e,this.B=t,this.amount=n,this.type="conjugate",Object.freeze(this)}}class Pause extends Move{constructor(){super(),this.type="pause",Object.freeze(this)}}class NewLine extends Annotation{constructor(){super(),this.type="newLine",Object.freeze(this)}}class CommentShort extends Annotation{constructor(e){super(),this.comment=e,this.type="commentShort",Object.freeze(this)}}class CommentLong extends Annotation{constructor(e){super(),this.comment=e,this.type="commentLong",Object.freeze(this)}}class BlockMove extends Move{constructor(e,t,n,r=1){if(super(),this.family=n,this.amount=r,this.type="blockMove",t&&(this.innerLayer=t,e&&(this.outerLayer=e)),e&&!t)throw new Error("Attempted to contruct block move with outer layer but no inner layer");Object.freeze(this)}}function c(e,t){return new BlockMove(void 0,void 0,e,t)}function f(e,t){var n,r,i,o;return new BlockMove(null!==(n=t.outerLayer)&&void 0!==n?n:e.outerLayer,null!==(r=t.innerLayer)&&void 0!==r?r:e.innerLayer,null!==(i=t.family)&&void 0!==i?i:e.family,null!==(o=t.amount)&&void 0!==o?o:e.amount)}function h(e,t,n){switch(t.type){case"sequence":return a(t,"sequence"),e.traverseSequence(t,n);case"group":return a(t,"group"),e.traverseGroup(t,n);case"blockMove":return a(t,"blockMove"),e.traverseBlockMove(t,n);case"commutator":return a(t,"commutator"),e.traverseCommutator(t,n);case"conjugate":return a(t,"conjugate"),e.traverseConjugate(t,n);case"pause":return a(t,"pause"),e.traversePause(t,n);case"newLine":return a(t,"newLine"),e.traverseNewLine(t,n);case"commentShort":return a(t,"commentShort"),e.traverseCommentShort(t,n);case"commentLong":return a(t,"commentLong"),e.traverseCommentLong(t,n);default:throw new Error(`Unknown AlgPart type: ${t.type}`)}}class TraversalDownUp{traverse(e,t){return h(this,e,t)}traverseIntoUnit(e,t){return u(this.traverse(e,t))}}class TraversalUp extends TraversalDownUp{traverse(e){return h(this,e,void 0)}traverseIntoUnit(e){return u(this.traverse(e))}}function m(e){const t=Math.abs(e);let n="";return 1!==t&&(n+=String(t)),t!==e&&(n+="'"),n}function d(e){let t=e.family+m(e.amount);return void 0!==e.innerLayer&&(t=String(e.innerLayer)+t,void 0!==e.outerLayer&&(t=String(e.outerLayer)+"-"+t)),t}const p=new class Invert extends TraversalUp{traverseSequence(e){return new Sequence(e.nestedUnits.slice().reverse().map(e=>this.traverseIntoUnit(e)))}traverseGroup(e){return new Group(this.traverseSequence(e.nestedSequence),e.amount)}traverseBlockMove(e){return new BlockMove(e.outerLayer,e.innerLayer,e.family,-e.amount)}traverseCommutator(e){return new Commutator(e.B,e.A,e.amount)}traverseConjugate(e){return new Conjugate(e.A,this.traverseSequence(e.B),e.amount)}traversePause(e){return e}traverseNewLine(e){return e}traverseCommentShort(e){return e}traverseCommentLong(e){return e}},v=new class Expand extends TraversalUp{traverseSequence(e){return new Sequence(this.flattenSequenceOneLevel(e.nestedUnits.map(e=>this.traverse(e))))}traverseGroup(e){return this.repeat(this.flattenSequenceOneLevel([this.traverse(e.nestedSequence)]),e)}traverseBlockMove(e){return e}traverseCommutator(e){const t=this.traverseSequence(e.A),n=this.traverseSequence(e.B);let r=[];return r=r.concat(t,n,w(t),w(n)),this.repeat(this.flattenSequenceOneLevel(r),e)}traverseConjugate(e){const t=this.traverseSequence(e.A),n=this.traverseSequence(e.B);let r=[];return r=r.concat(t,n,w(t)),this.repeat(this.flattenSequenceOneLevel(r),e)}traversePause(e){return e}traverseNewLine(e){return e}traverseCommentShort(e){return e}traverseCommentLong(e){return e}flattenSequenceOneLevel(e){let t=[];for(const n of e)if(s(n,"sequence"))t=t.concat(n.nestedUnits);else{if(!l(n))throw new Error("expand() encountered an internal error. Did you pass in a valid Algorithm?");t.push(n)}return t}repeat(e,t){const n=Math.abs(t.amount);let r;r=-1===(t.amount>0?1:-1)?w(new Sequence(e)).nestedUnits:e;let i=[];for(let e=0;e<n;e++)i=i.concat(r);return new Sequence(i)}},E=new class StructureEquals extends TraversalDownUp{traverseSequence(e,t){if(l(t))return!1;const n=t;if(e.nestedUnits.length!==n.nestedUnits.length)return!1;for(let t=0;t<e.nestedUnits.length;t++)if(!this.traverse(e.nestedUnits[t],n.nestedUnits[t]))return!1;return!0}traverseGroup(e,t){return s(t,"group")&&this.traverse(e.nestedSequence,t.nestedSequence)}traverseBlockMove(e,t){return s(t,"blockMove")&&e.outerLayer===t.outerLayer&&e.innerLayer===t.innerLayer&&e.family===t.family&&e.amount===t.amount}traverseCommutator(e,t){return s(t,"commutator")&&this.traverse(e.A,t.A)&&this.traverse(e.B,t.B)}traverseConjugate(e,t){return s(t,"conjugate")&&this.traverse(e.A,t.A)&&this.traverse(e.B,t.B)}traversePause(e,t){return s(t,"pause")}traverseNewLine(e,t){return s(t,"newLine")}traverseCommentShort(e,t){return s(t,"commentShort")&&e.comment===t.comment}traverseCommentLong(e,t){return s(t,"commentLong")&&e.comment===t.comment}},y=new class CoalesceBaseMoves extends TraversalUp{traverseSequence(e){const t=[];for(const n of e.nestedUnits)if(s(n,"blockMove"))if(t.length>0){const e=t[t.length-1];if(s(e,"blockMove")&&this.sameBlock(e,n)){const r=e.amount+n.amount;t.pop(),0!==r&&t.push(new BlockMove(n.outerLayer,n.innerLayer,n.family,r))}else t.push(n)}else t.push(n);else t.push(this.traverseIntoUnit(n));return new Sequence(t)}traverseGroup(e){return e}traverseBlockMove(e){return e}traverseCommutator(e){return e}traverseConjugate(e){return e}traversePause(e){return e}traverseNewLine(e){return e}traverseCommentShort(e){return e}traverseCommentLong(e){return e}sameBlock(e,t){return e.outerLayer===t.outerLayer&&e.innerLayer===t.innerLayer&&e.family===t.family}},g=new class ToString extends TraversalUp{traverseSequence(e){let t="";if(e.nestedUnits.length>0){t+=this.traverse(e.nestedUnits[0]);for(let n=1;n<e.nestedUnits.length;n++)t+=this.spaceBetween(e.nestedUnits[n-1],e.nestedUnits[n]),t+=this.traverse(e.nestedUnits[n])}return t}traverseGroup(e){return"("+this.traverse(e.nestedSequence)+")"+m(e.amount)}traverseBlockMove(e){return d(e)}traverseCommutator(e){return"["+this.traverse(e.A)+", "+this.traverse(e.B)+"]"+m(e.amount)}traverseConjugate(e){return"["+this.traverse(e.A)+": "+this.traverse(e.B)+"]"+m(e.amount)}traversePause(e){return"."}traverseNewLine(e){return"\n"}traverseCommentShort(e){return"//"+e.comment}traverseCommentLong(e){return"/*"+e.comment+"*/"}spaceBetween(e,t){return s(e,"pause")&&s(t,"pause")||s(e,"newLine")||s(t,"newLine")?"":s(e,"commentShort")&&!s(t,"newLine")?"\n":" "}},w=p.traverseSequence.bind(p),x=v.traverseSequence.bind(v),C=E.traverseSequence.bind(E),k=y.traverseSequence.bind(y),S=g.traverseSequence.bind(g),R=(g.traverse.bind(g),g.traverse.bind(g));var A;function b(e){if("sequence"!==e.type)throw new Error(`Expected Sequence while parsing, got: ${e.type}`);if(!e.nestedUnits)throw new Error("Missing nestedUnits");return new Sequence(e.nestedUnits.map(e=>function(e){switch(e.type){case"sequence":throw new Error("Expected AlgPart while parsing, got `Sequence`.");case"group":if(!e.nestedSequence)throw new Error("Missing nestedSequence");if(!e.amount)throw new Error("Missing amount");return new Group(b(e.nestedSequence),e.amount);case"blockMove":if(!e.family)throw new Error("Missing family");if(!e.amount)throw new Error("Missing amount");return new BlockMove(e.outerLayer,e.innerLayer,e.family,e.amount);case"commutator":if(!e.A)throw new Error("Missing A");if(!e.B)throw new Error("Missing B");if(!e.amount)throw new Error("Missing amount");return new Commutator(b(e.A),b(e.B),e.amount);case"conjugate":if(!e.A)throw new Error("Missing A");if(!e.B)throw new Error("Missing B");if(!e.amount)throw new Error("Missing amount");return new Conjugate(b(e.A),b(e.B),e.amount);case"pause":return new Pause;case"newLine":return new NewLine;case"commentShort":if(!e.comment)throw new Error("Missing comment");return new CommentShort(e.comment);case"commentLong":if(!e.comment)throw new Error("Missing comment");return new CommentLong(e.comment);default:throw new Error(`Unknown alg type: ${e.type}`)}}(e)))}!function(e){e.Sune=new Sequence([c("R",1),c("U",1),c("R",-1),c("U",1),c("R",1),c("U",-2),c("R",-1)]),e.AntiSune=new Sequence([c("R",1),c("U",2),c("R",-1),c("U",-1),c("R",1),c("U",-1),c("R",-1)]),e.SuneCommutator=new Sequence([new Commutator(new Sequence([c("R",1),c("U",1),c("R",-2)]),new Sequence([new Conjugate(new Sequence([c("R",1)]),new Sequence([c("U",1)]),1)]),1)]),e.Niklas=new Sequence([c("R",1),c("U",-1),c("L",-1),c("U",1),c("R",-1),c("U",-1),c("L",1),c("U",1)]),e.EPerm=new Sequence([c("x",-1),new Commutator(new Sequence([new Conjugate(new Sequence([c("R",1)]),new Sequence([c("U",-1)]))]),new Sequence([c("D",1)]),1),new Commutator(new Sequence([new Conjugate(new Sequence([c("R",1)]),new Sequence([c("U",1)]))]),new Sequence([c("D",1)]),1),c("x",1)]),e.FURURFCompact=new Sequence([new Conjugate(new Sequence([c("F",1)]),new Sequence([new Commutator(new Sequence([c("U",1)]),new Sequence([c("R",1)]),1)]),1)]),e.APermCompact=new Sequence([new Conjugate(new Sequence([c("R",2)]),new Sequence([new Commutator(new Sequence([c("F",2)]),new Sequence([c("R",-1),c("B",-1),c("R",1)]),1)]),1)]),e.FURURFMoves=new Sequence([c("F",1),c("U",1),c("R",1),c("U",-1),c("R",-1),c("F",-1)]),e.TPerm=new Sequence([c("R",1),c("U",1),c("R",-1),c("U",-1),c("R",-1),c("F",1),c("R",2),c("U",-1),c("R",-1),c("U",-1),c("R",1),c("U",1),c("R",-1),c("F",-1)]),e.HeadlightSwaps=new Sequence([new Conjugate(new Sequence([c("F",1)]),new Sequence([new Commutator(new Sequence([c("R",1)]),new Sequence([c("U",1)]),3)]),1)]),e.TriplePause=new Sequence([new Pause,new Pause,new Pause]),e.AllAlgParts=[new Sequence([c("R",1),c("U",-1)]),new Group(new Sequence([c("F",1)]),2),c("R",2),new Commutator(new Sequence([c("R",2)]),new Sequence([c("U",2)]),2),new Conjugate(new Sequence([c("L",2)]),new Sequence([c("D",-1)]),2),new Pause,new NewLine,new CommentShort("short comment"),new CommentLong("long comment")]}(A||(A={}));class ValidationError extends Error{}class ValidatorTraversal extends TraversalUp{}function N(e,t){for(const n of t)if(!0===n[e])return!0;return!1}const T={x:!0,y:!0,z:!0,M:!0,E:!0,S:!0,m:!0,e:!0,s:!0},L={U:!0,L:!0,F:!0,R:!0,B:!0,D:!0},U={u:!0,l:!0,f:!0,r:!0,b:!0,d:!0,Uw:!0,Lw:!0,Fw:!0,Rw:!0,Bw:!0,Dw:!0};class BaseMoveValidator extends ValidatorTraversal{traverseSequence(e){for(const t of e.nestedUnits)this.traverse(t)}traverseGroup(e){return this.traverse(e.nestedSequence)}traverseCommutator(e){this.traverse(e.A),this.traverse(e.B)}traverseConjugate(e){this.traverse(e.A),this.traverse(e.B)}traversePause(e){}traverseNewLine(e){}traverseCommentShort(e){}traverseCommentLong(e){}}const D=new class BlockMoveValidator extends BaseMoveValidator{traverseBlockMove(e){if(void 0===e.outerLayer)if(void 0===e.innerLayer){if(!N(e.family,[U,L,T]))throw new ValidationError(`Invalid SiGN plain move family: ${e.family}`)}else{if(!N(e.family,[U,L]))throw new ValidationError(`The provided SiGN move family is invalid, or cannot have an inner slice: ${e.family}`);if(e.innerLayer<=0)throw new ValidationError("Cannot have an inner layer of 0 or less.")}else{if(void 0===e.innerLayer)throw new ValidationError("A BlockMove with an outer layer must have an inner layer.");if(!N(e.family,[U]))throw new ValidationError(`The provided SiGN move family is invalid, or cannot have an outer and inner layer: ${e.family}`);if(e.outerLayer<=0)throw new ValidationError("Cannot have an outer layer of 0 or less.");if(e.outerLayer>=e.innerLayer)throw new ValidationError("The outer layer must be less than the inner layer.")}}},M=D.traverse.bind(D),G=new class FlatAlgValidator extends ValidatorTraversal{traverseSequence(e){for(const t of e.nestedUnits)this.traverse(t)}traverseGroup(e){throw new ValidationError("A flat alg cannot contain a group.")}traverseBlockMove(e){}traverseCommutator(e){throw new ValidationError("A flat alg cannot contain a commutator.")}traverseConjugate(e){throw new ValidationError("A flat alg cannot contain a conjugate.")}traversePause(e){}traverseNewLine(e){}traverseCommentShort(e){}traverseCommentLong(e){}},z=G.traverse.bind(G);var P=function(){function e(t,n,r,i){this.message=t,this.expected=n,this.found=r,this.location=i,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}return function(e,t){function n(){this.constructor=e}n.prototype=t.prototype,e.prototype=new n}(e,Error),e.buildMessage=function(e,t){var n={literal:function(e){return'"'+i(e.text)+'"'},class:function(e){var t,n="";for(t=0;t<e.parts.length;t++)n+=e.parts[t]instanceof Array?o(e.parts[t][0])+"-"+o(e.parts[t][1]):o(e.parts[t]);return"["+(e.inverted?"^":"")+n+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};function r(e){return e.charCodeAt(0).toString(16).toUpperCase()}function i(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+r(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+r(e)}))}function o(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+r(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+r(e)}))}return"Expected "+function(e){var t,r,i,o=new Array(e.length);for(t=0;t<e.length;t++)o[t]=(i=e[t],n[i.type](i));if(o.sort(),o.length>0){for(t=1,r=1;t<o.length;t++)o[t-1]!==o[t]&&(o[r]=o[t],r++);o.length=r}switch(o.length){case 1:return o[0];case 2:return o[0]+" or "+o[1];default:return o.slice(0,-1).join(", ")+", or "+o[o.length-1]}}(e)+" but "+function(e){return e?'"'+i(e)+'"':"end of input"}(t)+" found."},{SyntaxError:e,parse:function(t,n){n=void 0!==n?n:{};var r,i,o,s,a={},l={start:j},u=j,c=/^[0-9]/,f=O([["0","9"]],!1,!1),h=B("'",!1),m=/^[_A-Za-z]/,d=O(["_",["A","Z"],["a","z"]],!1,!1),p=B("-",!1),v=B("[",!1),E=/^[,:]/,y=O([",",":"],!1,!1),g=B("]",!1),w=B("(",!1),x=B(")",!1),C=B("//",!1),k=/^[^\n\r]/,S=O(["\n","\r"],!0,!1),R=B("/*",!1),A=/^[^*]/,b=O(["*"],!0,!1),N=B("*/",!1),T=/^[\n\r]/,L=O(["\n","\r"],!1,!1),U=B(".",!1),D=/^[ ]/,M=O([" "],!1,!1),G=0,z=[{line:1,column:1}],P=0,q=[];if("startRule"in n){if(!(n.startRule in l))throw new Error("Can't start parsing from rule \""+n.startRule+'".');u=l[n.startRule]}function B(e,t){return{type:"literal",text:e,ignoreCase:t}}function O(e,t,n){return{type:"class",parts:e,inverted:t,ignoreCase:n}}function F(e){var n,r=z[e];if(r)return r;for(n=e-1;!z[n];)n--;for(r={line:(r=z[n]).line,column:r.column};n<e;)10===t.charCodeAt(n)?(r.line++,r.column=1):r.column++,n++;return z[e]=r,r}function V(e,t){var n=F(e),r=F(t);return{start:{offset:e,line:n.line,column:n.column},end:{offset:t,line:r.line,column:r.column}}}function I(e){G<P||(G>P&&(P=G,q=[]),q.push(e))}function j(){return Y()}function Q(){var e,n;if(G,e=[],c.test(t.charAt(G))?(n=t.charAt(G),G++):(n=a,I(f)),n!==a)for(;n!==a;)e.push(n),c.test(t.charAt(G))?(n=t.charAt(G),G++):(n=a,I(f));else e=a;return e!==a&&(e=parseInt(e.join(""),10)),e}function $(){var e,n;if(G,e=[],m.test(t.charAt(G))?(n=t.charAt(G),G++):(n=a,I(d)),n!==a)for(;n!==a;)e.push(n),m.test(t.charAt(G))?(n=t.charAt(G),G++):(n=a,I(d));else e=a;return e!==a&&(e=e.join("")),e}function K(){var e,n,r,i,o,s;return(e=function(){var e,n,r,i,o;return e=G,(n=$())!==a&&(n={type:"blockMove",family:n}),(e=n)===a&&(e=G,(n=Q())!==a&&(r=$())!==a?e=n=function(e,t){return{type:"blockMove",family:t,innerLayer:e}}(n,r):(G=e,e=a),e===a&&(e=G,(n=Q())!==a?(45===t.charCodeAt(G)?(r="-",G++):(r=a,I(p)),r!==a&&(i=Q())!==a&&(o=$())!==a?e=n=function(e,t,n){return{type:"blockMove",family:n,outerLayer:e,innerLayer:t}}(n,i,o):(G=e,e=a)):(G=e,e=a))),e}())===a&&(e=G,91===t.charCodeAt(G)?(n="[",G++):(n=a,I(v)),n!==a&&(r=Y())!==a?(E.test(t.charAt(G))?(i=t.charAt(G),G++):(i=a,I(y)),i!==a&&(o=Y())!==a?(93===t.charCodeAt(G)?(s="]",G++):(s=a,I(g)),s!==a?e=n={type:","===i?"commutator":"conjugate",A:r,B:o}:(G=e,e=a)):(G=e,e=a)):(G=e,e=a),e===a&&(e=G,40===t.charCodeAt(G)?(n="(",G++):(n=a,I(w)),n!==a&&(r=Y())!==a?(41===t.charCodeAt(G)?(i=")",G++):(i=a,I(x)),i!==a?e=n={type:"group",nestedSequence:r}:(G=e,e=a)):(G=e,e=a))),e}function _(){var e,n,r,i,o;return e=G,(n=K())!==a&&(r=function(){var e,n,r;return e=G,(n=Q())!==a?(39===t.charCodeAt(G)?(r="'",G++):(r=a,I(h)),r!==a?e=n=-n:(G=e,e=a)):(G=e,e=a),e===a&&(e=Q())===a&&(e=G,39===t.charCodeAt(G)?(n="'",G++):(n=a,I(h)),n!==a&&(n=-1),e=n),e}())!==a?(o=r,(i=n).amount=o,e=n=i):(G=e,e=a),e===a&&(e=G,(n=K())!==a&&(n=function(e){return e.amount=1,e}(n)),e=n),e}function W(){var e,n;return e=G,T.test(t.charAt(G))?(n=t.charAt(G),G++):(n=a,I(L)),n!==a&&(n={type:"newLine"}),(e=n)===a&&(e=G,46===t.charCodeAt(G)?(n=".",G++):(n=a,I(U)),n!==a&&(n={type:"pause"}),(e=n)===a&&(e=function(){var e,n,r,i;if(e=G,"//"===t.substr(G,2)?(n="//",G+=2):(n=a,I(C)),n!==a){for(r=[],k.test(t.charAt(G))?(i=t.charAt(G),G++):(i=a,I(S));i!==a;)r.push(i),k.test(t.charAt(G))?(i=t.charAt(G),G++):(i=a,I(S));r!==a?e=n={type:"commentShort",comment:r.join("")}:(G=e,e=a)}else G=e,e=a;if(e===a)if(e=G,"/*"===t.substr(G,2)?(n="/*",G+=2):(n=a,I(R)),n!==a){for(r=[],A.test(t.charAt(G))?(i=t.charAt(G),G++):(i=a,I(b));i!==a;)r.push(i),A.test(t.charAt(G))?(i=t.charAt(G),G++):(i=a,I(b));r!==a?("*/"===t.substr(G,2)?(i="*/",G+=2):(i=a,I(N)),i!==a?e=n=function(e){return{type:"commentLong",comment:e.join("")}}(r):(G=e,e=a)):(G=e,e=a)}else G=e,e=a;return e}())),e}function Z(){var e;return(e=_())===a&&(e=W()),e}function H(){var e,t,n;return e=G,(t=Z())!==a&&(n=H())!==a?e=t=[t].concat(n):(G=e,e=a),e===a&&(e=G,(t=Z())!==a&&(t=function(e){return[e]}(t)),e=t),e}function Y(){var e,n,r,i,o;for(e=G,n=[],D.test(t.charAt(G))?(r=t.charAt(G),G++):(r=a,I(M));r!==a;)n.push(r),D.test(t.charAt(G))?(r=t.charAt(G),G++):(r=a,I(M));if(n!==a)if((r=function e(){var n,r,i,o,s;if(n=G,(r=H())!==a){if(i=[],D.test(t.charAt(G))?(o=t.charAt(G),G++):(o=a,I(M)),o!==a)for(;o!==a;)i.push(o),D.test(t.charAt(G))?(o=t.charAt(G),G++):(o=a,I(M));else i=a;i!==a&&(o=e())!==a?(s=o,n=r=r.concat(s)):(G=n,n=a)}else G=n,n=a;return n===a&&(n=H()),n}())!==a){for(i=[],D.test(t.charAt(G))?(o=t.charAt(G),G++):(o=a,I(M));o!==a;)i.push(o),D.test(t.charAt(G))?(o=t.charAt(G),G++):(o=a,I(M));i!==a?e=n={type:"sequence",nestedUnits:r}:(G=e,e=a)}else G=e,e=a;else G=e,e=a;if(e===a){for(e=G,n=[],D.test(t.charAt(G))?(r=t.charAt(G),G++):(r=a,I(M));r!==a;)n.push(r),D.test(t.charAt(G))?(r=t.charAt(G),G++):(r=a,I(M));n!==a&&(n={type:"sequence",nestedUnits:[]}),e=n}return e}if((r=u())!==a&&G===t.length)return r;throw r!==a&&G<t.length&&I({type:"end"}),i=q,o=P<t.length?t.charAt(P):null,s=P<t.length?V(P,P+1):V(P,P),new e(e.buildMessage(i,o),i,o,s)}}}();const{parse:q}=P;function B(e,t={validators:[]}){t.validators=t.validators||[];const n=b(q(e));for(const e of t.validators)e(n);return n}const O={73:c("R"),75:c("R",-1),87:c("B"),79:c("B",-1),83:c("D"),76:c("D",-1),68:c("L"),69:c("L",-1),74:c("U"),70:c("U",-1),72:c("F"),71:c("F",-1),78:c("F"),86:c("F",-1),67:c("l"),82:c("l",-1),85:c("r"),77:c("r",-1),84:c("x"),89:c("x"),66:c("x",-1),186:c("y"),59:c("y"),65:c("y",-1),80:c("z"),81:c("z",-1),190:c("M",-1)};function F(e){return e.altKey||e.ctrlKey?null:O[e.keyCode]||null}function V(e){let t=S(e);return t=t.replace(/_/g,"&#95;").replace(/ /g,"_"),t=t.replace(/\+/g,"&#2b;"),t=t.replace(/-/g,"&#45;").replace(/'/g,"-"),t}function I(e){let t=e;return t=t.replace(/-/g,"'").replace(/&#45;/g,"-"),t=t.replace(/\+/g," ").replace(/&#2b;/g,"+"),t=t.replace(/_/g," ").replace(/&#95;/g,"_"),B(t)}var j=Object.freeze({__proto__:null,AlgPart:AlgPart,Unit:Unit,Move:Move,Container:Container,Annotation:Annotation,Sequence:Sequence,Group:Group,BlockMove:BlockMove,BareBlockMove:c,LayerBlockMove:function(e,t,n){return new BlockMove(void 0,e,t,n)},RangeBlockMove:function(e,t,n,r){return new BlockMove(e,t,n,r)},Commutator:Commutator,Conjugate:Conjugate,Pause:Pause,NewLine:NewLine,CommentShort:CommentShort,CommentLong:CommentLong,modifiedBlockMove:f,experimentalAppendBlockMove:function(e,t,n=!1,r=0){const i=e.nestedUnits,o=i[i.length-1];if(n&&o&&(a=t,(s=o).family===a.family&&s.innerLayer===a.innerLayer&&s.outerLayer===a.outerLayer)){const n=e.nestedUnits.slice(0,i.length-1);let s=o.amount+t.amount;return r>1&&(s=(s%r+r)%r,2*s>r&&(s-=r)),0!==s&&n.push(f(o,{amount:s})),new Sequence(n)}return new Sequence([...i,t]);var s,a},experimentalConcatAlgs:function(...e){return new Sequence(Array.prototype.concat.apply([],[...e].map(e=>e.nestedUnits)))},TraversalDownUp:TraversalDownUp,TraversalUp:TraversalUp,invert:w,expand:x,structureEquals:C,coalesceBaseMoves:k,algToString:S,algPartToStringForTesting:R,blockMoveToString:d,get Example(){return A},fromJSON:b,parse:B,keyToMove:F,validateSiGNMoves:M,validateFlatAlg:z,validateSiGNAlg:function(e){M(e),z(e)},ValidationError:ValidationError,serializeURLParam:V,deserializeURLParam:I,algCubingNetLink:function(e){const t=new URL("https://alg.cubing.net");if(!e.alg)throw new Error("An alg parameter is required.");if(t.searchParams.set("alg",V(e.alg)),e.setup&&t.searchParams.set("setup",V(e.setup)),e.title&&t.searchParams.set("title",e.title),e.puzzle){if(-1===["1x1x1","2x2x2","3x3x3","4x4x4","5x5x5","6x6x6","7x7x7","8x8x8","9x9x9","10x10x10","11x11x11","12x12x12","13x13x13","14x14x14","16x16x16","17x17x17"].indexOf(e.puzzle))throw new Error(`Invalid puzzle parameter: ${e.puzzle}`);t.searchParams.set("puzzle",e.puzzle)}if(e.stage){if(-1===["full","cross","F2L","LL","OLL","PLL","CLS","ELS","L6E","CMLL","WV","ZBLL","void"].indexOf(e.stage))throw new Error(`Invalid stage parameter: ${e.stage}`);t.searchParams.set("stage",e.stage)}if(e.view){if(-1===["editor","playback","fullscreen"].indexOf(e.view))throw new Error(`Invalid view parameter: ${e.view}`);t.searchParams.set("view",e.view)}if(e.type){if(-1===["moves","reconstruction","alg","reconstruction-end-with-setup"].indexOf(e.type))throw new Error(`Invalid type parameter: ${e.type}`);t.searchParams.set("type",e.type)}return t.toString()},getAlgURLParam:function(e){return I(new URLSearchParams(window.location.search).get(e)||"")},setAlgPartTypeMismatchReportingLevel:function(e){r=e}});
/*! *****************************************************************************
  Copyright (c) Microsoft Corporation. All rights reserved.
  Licensed under the Apache License, Version 2.0 (the "License"); you may not use
  this file except in compliance with the License. You may obtain a copy of the
  License at http://www.apache.org/licenses/LICENSE-2.0

  THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
  WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
  MERCHANTABLITY OR NON-INFRINGEMENT.

  See the Apache Version 2.0 License for specific language governing permissions
  and limitations under the License.
  ***************************************************************************** */function Q(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{l(r.next(e))}catch(e){o(e)}}function a(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){e.done?i(e.value):new n((function(t){t(e.value)})).then(s,a)}l((r=r.apply(e,t||[])).next())}))}function $(e,t,n){const r={};for(const i in e.orbits){const o=e.orbits[i],s=t[i],a=n[i],l=new Array(o.numPieces),u=new Array(o.numPieces);for(let e=0;e<o.numPieces;e++)u[e]=(s.orientation[a.permutation[e]]+a.orientation[e])%o.orientations,l[e]=s.permutation[a.permutation[e]];r[i]={permutation:l,orientation:u}}return r}function K(e,t,n){if(n<0)return K(e,W(e,t),-n);if(0===n)return _(e);if(1===n)return t;const r=K(e,t,Math.floor(n/2)),i=$(e,r,r);return n%2==0?i:$(e,t,i)}function _(e){const t={};for(const n in e.orbits){const r=e.orbits[n],i=new Array(r.numPieces),o=new Array(r.numPieces);for(let e=0;e<r.numPieces;e++)i[e]=e,o[e]=0;const s={permutation:i,orientation:o};t[n]=s}return t}function W(e,t){const n={};for(const r in e.orbits){const i=e.orbits[r],o=t[r],s=new Array(i.numPieces),a=new Array(i.numPieces);for(let e=0;e<i.numPieces;e++){const t=o.permutation[e];s[t]=e,a[t]=(i.orientations-o.orientation[e]+i.orientations)%i.orientations}n[r]={permutation:s,orientation:a}}return n}function Z(e,t){return t?Z(t,e%t):e}function H(e,t,n){for(const r in e.orbits){const i=e.orbits[r],o=t[r],s=n[r];for(let e=0;e<i.numPieces;e++){if(o.orientation[e]!==s.orientation[e])return!1;if(o.permutation[e]!==s.permutation[e])return!1}}return!0}function Y(e,t){const n=d(new BlockMove(t.outerLayer,t.innerLayer,t.family,1));let r=e.moves[n];if(r||(r=new KPuzzle(e).expandSlices(n,t)),!r)throw new Error(`Unknown move family: ${t.family}`);return K(e,r,t.amount)}class KPuzzle{constructor(e){this.definition=e,this.state=_(e)}serialize(){let e="";for(const t in this.definition.orbits)e+=t+"\n",e+=this.state[t].permutation.join(" ")+"\n",e+=this.state[t].orientation.join(" ")+"\n";return e=e.slice(0,e.length-1),e}applyBlockMove(e){this.state=$(this.definition,this.state,Y(this.definition,e))}applyAlg(e){for(const t of x(e).nestedUnits)this.applyBlockMove(t)}applyMove(e){let t=this.definition.moves[e];if(t||(t=this.expandSlicesByName(e)),!t)throw new Error(`Unknown move: ${e}`);return this.state=$(this.definition,this.state,t),this}getMoveExpander(e){let t=this.definition.moveExpander;return e&&!t&&(t=new MoveExpander,this.definition.moveExpander=t),t}setFaceNames(e){const t=this.getMoveExpander(!0);t&&t.setFaceNames(e)}addGrip(e,t,n){const r=this.getMoveExpander(!0);return r?r.addGrip(e,t,n,this.definition):void 0}expandSlices(e,t){const n=this.getMoveExpander(!1);return n?n.expandSlices(e,t,this.definition):void 0}expandSlicesByName(e){const t=this.getMoveExpander(!1);return t?t.expandSlicesByName(e,this.definition):void 0}unswizzle(e){const t=this.getMoveExpander(!0);return t?t.unswizzle(e):e}}class MoveExpander{constructor(){this.gripStash={},this.moveStash={},this.regrip={}}setFaceNames(e){this.facenames=e}addGrip(e,t,n,r){const i=[],o=this.gripStash,s=r.moves;for(let o=1;o<=n;o++){let a=1===o&&s[e]||s[""+o+e];if(a||(a=o===n&&s[t]||s[""+(n+1-o)+t],a&&(a=W(r,a))),!a)throw new Error("Could not expand axis "+e+" to "+t+" because we are missing a move for slice "+o);i.push(a)}o[e]=i;const a=i.map(e=>W(r,e));a.reverse(),o[t]=a}expandSlicesByName(e,t){const n=this.moveStash[e];if(n)return n;try{const n=B(e);if(1!==n.nestedUnits.length)return;const r=n.nestedUnits[0];return this.expandSlices(e,r,t)}catch(e){return}}unswizzle(e){if(this.regrip[e])return this.regrip[e];if(!this.facenames)return e;e.length>1&&e[0]<="Z"&&("w"===e[e.length-1]||"v"===e[e.length-1])&&(e=e.substr(0,e.length-1));const t=this.splitByFaceNames(e,this.facenames);if(t)for(let n=0;n<t.length;n++){let r="";for(let e=0;e<t.length;e++)r+=t[(n+e)%t.length];if(this.gripStash[r])return this.regrip[e]=r,r}return e}expandSlices(e,t,n){const r=this.moveStash[e];if(r)return r;const i=this.gripStash,o=t.family;let s=o,a=!1,l=!1;/[a-z]/.test(o)&&(a=!0,s=o.toUpperCase()),o.length>1&&o.endsWith("w")&&(a=!0,s=o.substring(0,o.length-1)),o.length>1&&o.endsWith("v")&&(l=!0,s=o.substring(0,o.length-1));let u=i[s];if(!u&&this.facenames&&(s=this.unswizzle(s),u=i[s]),!u)return;let c=t.outerLayer,f=t.innerLayer;if(void 0===f){if(void 0!==c)return;c=1,f=a?2:1,l&&(f=i[s].length)}else void 0===c&&(c=a?1:f);if(f<c)return;if(c>i[s].length)return;let h=u[c-1];for(let e=c+1;e<=f;e++)h=$(n,h,u[e-1]);return this.moveStash[e]=h,h}splitByFaceNames(e,t){const n=[];let r=0;for(e=e.toUpperCase();r<e.length;){let i=!1;for(const o of t)if(e.substr(r).startsWith(o)){n.push(o),r+=o.length,i=!0;break}if(!i)return}return n}}const J={"2x2x2":{name:"2x2x2",orbits:{CORNERS:{numPieces:7,orientations:3}},startPieces:{CORNERS:{permutation:[0,1,2,3,4,5,6],orientation:[0,0,0,0,0,0,0]}},moves:{U:{CORNERS:{permutation:[3,0,1,2,4,5,6],orientation:[0,0,0,0,0,0,0]}},R:{CORNERS:{permutation:[0,2,5,3,1,4,6],orientation:[0,2,1,0,1,2,0]}},F:{CORNERS:{permutation:[0,1,3,6,4,2,5],orientation:[0,0,0,0,0,0,0]}}},svg:'<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.0//EN"\n       "http://www.w3.org/TR/2001/REC-SVG-20050904/DTD/svg11.dtd">\n<svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 490 370" preserveAspectRatio="xMidYMid meet">\n  <defs>\n  </defs>\n  <title>2x2x2</title>\n  <defs>\n    <g id="sticker">\n        <rect x="0" y="0" width="1" height="1" stroke="black" stroke-width="0.04px" />\n    </g>\n  </defs>\n  <g id="puzzle" transform="translate(5, 5) scale(60)">\n    <use id="CORNERS-l0-o0" xlink:href="#sticker" transform="translate(2, 0)" style="fill: white"/>\n    <use id="CORNERS-l0-o1" xlink:href="#sticker" transform="translate(7, 2)" style="fill: blue"/>\n    <use id="CORNERS-l0-o2" xlink:href="#sticker" transform="translate(0, 2)" style="fill: orange"/>\n\n    <use id="CORNERS-l1-o0" xlink:href="#sticker" transform="translate(3, 0)" style="fill: white"/>\n    <use id="CORNERS-l1-o1" xlink:href="#sticker" transform="translate(5, 2)" style="fill: red"/>\n    <use id="CORNERS-l1-o2" xlink:href="#sticker" transform="translate(6, 2)" style="fill: blue"/>\n\n    <use id="CORNERS-l2-o0" xlink:href="#sticker" transform="translate(3, 1)" style="fill: white"/>\n    <use id="CORNERS-l2-o1" xlink:href="#sticker" transform="translate(3, 2)" style="fill: green"/>\n    <use id="CORNERS-l2-o2" xlink:href="#sticker" transform="translate(4, 2)" style="fill: red"/>\n\n    <use id="CORNERS-l3-o0" xlink:href="#sticker" transform="translate(2, 1)" style="fill: white"/>\n    <use id="CORNERS-l3-o1" xlink:href="#sticker" transform="translate(1, 2)" style="fill: orange"/>\n    <use id="CORNERS-l3-o2" xlink:href="#sticker" transform="translate(2, 2)" style="fill: green"/>\n\n    <use id="CORNERS-l4-o0" xlink:href="#sticker" transform="translate(3, 5)" style="fill: yellow"/>\n    <use id="CORNERS-l4-o1" xlink:href="#sticker" transform="translate(6, 3)" style="fill: blue"/>\n    <use id="CORNERS-l4-o2" xlink:href="#sticker" transform="translate(5, 3)" style="fill: red"/>\n\n    <use id="CORNERS-l5-o0" xlink:href="#sticker" transform="translate(3, 4)" style="fill: yellow"/>\n    <use id="CORNERS-l5-o1" xlink:href="#sticker" transform="translate(4, 3)" style="fill: red"/>\n    <use id="CORNERS-l5-o2" xlink:href="#sticker" transform="translate(3, 3)" style="fill: green"/>\n\n    <use id="CORNERS-l6-o0" xlink:href="#sticker" transform="translate(2, 4)" style="fill: yellow"/>\n    <use id="CORNERS-l6-o1" xlink:href="#sticker" transform="translate(2, 3)" style="fill: green"/>\n    <use id="CORNERS-l6-o2" xlink:href="#sticker" transform="translate(1, 3)" style="fill: orange"/>\n\n    <use                    xlink:href="#sticker" transform="translate(2, 5)" style="fill: yellow"/>\n    <use                    xlink:href="#sticker" transform="translate(0, 3)" style="fill: orange"/>\n    <use                    xlink:href="#sticker" transform="translate(7, 3)" style="fill: blue"/>\n  </g>\n\n</svg>'},"3x3x3":{name:"3x3x3",orbits:{EDGE:{numPieces:12,orientations:2},CORNER:{numPieces:8,orientations:3},CENTER:{numPieces:6,orientations:4}},startPieces:{EDGE:{permutation:[0,1,2,3,4,5,6,7,8,9,10,11],orientation:[0,0,0,0,0,0,0,0,0,0,0,0]},CORNER:{permutation:[0,1,2,3,4,5,6,7],orientation:[0,0,0,0,0,0,0,0]},CENTER:{permutation:[0,1,2,3,4,5],orientation:[0,0,0,0,0,0]}},moves:{U:{EDGE:{permutation:[1,2,3,0,4,5,6,7,8,9,10,11],orientation:[0,0,0,0,0,0,0,0,0,0,0,0]},CORNER:{permutation:[1,2,3,0,4,5,6,7],orientation:[0,0,0,0,0,0,0,0]},CENTER:{permutation:[0,1,2,3,4,5],orientation:[1,0,0,0,0,0]}},y:{EDGE:{permutation:[1,2,3,0,5,6,7,4,10,8,11,9],orientation:[0,0,0,0,0,0,0,0,1,1,1,1]},CORNER:{permutation:[1,2,3,0,7,4,5,6],orientation:[0,0,0,0,0,0,0,0]},CENTER:{permutation:[0,2,3,4,1,5],orientation:[1,0,0,0,0,3]}},x:{EDGE:{permutation:[4,8,0,9,6,10,2,11,5,7,1,3],orientation:[1,0,1,0,1,0,1,0,0,0,0,0]},CORNER:{permutation:[4,0,3,5,7,6,2,1],orientation:[2,1,2,1,1,2,1,2]},CENTER:{permutation:[2,1,5,3,0,4],orientation:[0,3,0,1,2,2]}},L:{EDGE:{permutation:[0,1,2,11,4,5,6,9,8,3,10,7],orientation:[0,0,0,0,0,0,0,0,0,0,0,0]},CORNER:{permutation:[0,1,6,2,4,3,5,7],orientation:[0,0,2,1,0,2,1,0]},CENTER:{permutation:[0,1,2,3,4,5],orientation:[0,1,0,0,0,0]}},F:{EDGE:{permutation:[9,1,2,3,8,5,6,7,0,4,10,11],orientation:[1,0,0,0,1,0,0,0,1,1,0,0]},CORNER:{permutation:[3,1,2,5,0,4,6,7],orientation:[1,0,0,2,2,1,0,0]},CENTER:{permutation:[0,1,2,3,4,5],orientation:[0,0,1,0,0,0]}},R:{EDGE:{permutation:[0,8,2,3,4,10,6,7,5,9,1,11],orientation:[0,0,0,0,0,0,0,0,0,0,0,0]},CORNER:{permutation:[4,0,2,3,7,5,6,1],orientation:[2,1,0,0,1,0,0,2]},CENTER:{permutation:[0,1,2,3,4,5],orientation:[0,0,0,1,0,0]}},B:{EDGE:{permutation:[0,1,10,3,4,5,11,7,8,9,6,2],orientation:[0,0,1,0,0,0,1,0,0,0,1,1]},CORNER:{permutation:[0,7,1,3,4,5,2,6],orientation:[0,2,1,0,0,0,2,1]},CENTER:{permutation:[0,1,2,3,4,5],orientation:[0,0,0,0,1,0]}},D:{EDGE:{permutation:[0,1,2,3,7,4,5,6,8,9,10,11],orientation:[0,0,0,0,0,0,0,0,0,0,0,0]},CORNER:{permutation:[0,1,2,3,5,6,7,4],orientation:[0,0,0,0,0,0,0,0]},CENTER:{permutation:[0,1,2,3,4,5],orientation:[0,0,0,0,0,1]}},z:{EDGE:{permutation:[9,3,11,7,8,1,10,5,0,4,2,6],orientation:[1,1,1,1,1,1,1,1,1,1,1,1]},CORNER:{permutation:[3,2,6,5,0,4,7,1],orientation:[1,2,1,2,2,1,2,1]},CENTER:{permutation:[1,5,2,0,4,3],orientation:[1,1,1,1,3,1]}},M:{EDGE:{permutation:[2,1,6,3,0,5,4,7,8,9,10,11],orientation:[1,0,1,0,1,0,1,0,0,0,0,0]},CORNER:{permutation:[0,1,2,3,4,5,6,7],orientation:[0,0,0,0,0,0,0,0]},CENTER:{permutation:[4,1,0,3,5,2],orientation:[2,0,0,0,2,0]}},E:{EDGE:{permutation:[0,1,2,3,4,5,6,7,9,11,8,10],orientation:[0,0,0,0,0,0,0,0,1,1,1,1]},CORNER:{permutation:[0,1,2,3,4,5,6,7],orientation:[0,0,0,0,0,0,0,0]},CENTER:{permutation:[0,4,1,2,3,5],orientation:[0,0,0,0,0,0]}},S:{EDGE:{permutation:[0,3,2,7,4,1,6,5,8,9,10,11],orientation:[0,1,0,1,0,1,0,1,0,0,0,0]},CORNER:{permutation:[0,1,2,3,4,5,6,7],orientation:[0,0,0,0,0,0,0,0]},CENTER:{permutation:[1,5,2,0,4,3],orientation:[1,1,0,1,0,1]}},u:{EDGE:{permutation:[1,2,3,0,4,5,6,7,10,8,11,9],orientation:[0,0,0,0,0,0,0,0,1,1,1,1]},CORNER:{permutation:[1,2,3,0,4,5,6,7],orientation:[0,0,0,0,0,0,0,0]},CENTER:{permutation:[0,2,3,4,1,5],orientation:[1,0,0,0,0,0]}},l:{EDGE:{permutation:[2,1,6,11,0,5,4,9,8,3,10,7],orientation:[1,0,1,0,1,0,1,0,0,0,0,0]},CORNER:{permutation:[0,1,6,2,4,3,5,7],orientation:[0,0,2,1,0,2,1,0]},CENTER:{permutation:[4,1,0,3,5,2],orientation:[2,1,0,0,2,0]}},f:{EDGE:{permutation:[9,3,2,7,8,1,6,5,0,4,10,11],orientation:[1,1,0,1,1,1,0,1,1,1,0,0]},CORNER:{permutation:[3,1,2,5,0,4,6,7],orientation:[1,0,0,2,2,1,0,0]},CENTER:{permutation:[1,5,2,0,4,3],orientation:[1,1,1,1,0,1]}},r:{EDGE:{permutation:[4,8,0,3,6,10,2,7,5,9,1,11],orientation:[1,0,1,0,1,0,1,0,0,0,0,0]},CORNER:{permutation:[4,0,2,3,7,5,6,1],orientation:[2,1,0,0,1,0,0,2]},CENTER:{permutation:[2,1,5,3,0,4],orientation:[0,0,0,1,2,2]}},b:{EDGE:{permutation:[8,5,2,1,9,7,6,3,4,0,10,11],orientation:[1,1,0,1,1,1,0,1,1,1,0,0]},CORNER:{permutation:[4,1,2,0,5,3,6,7],orientation:[1,0,0,2,2,1,0,0]},CENTER:{permutation:[3,0,2,5,4,1],orientation:[3,3,3,3,0,3]}},d:{EDGE:{permutation:[0,1,2,3,7,4,5,6,9,11,8,10],orientation:[0,0,0,0,0,0,0,0,1,1,1,1]},CORNER:{permutation:[0,1,2,3,5,6,7,4],orientation:[0,0,0,0,0,0,0,0]},CENTER:{permutation:[0,4,1,2,3,5],orientation:[0,0,0,0,0,1]}}},svg:'<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.0//EN"\n       "http://www.w3.org/TR/2001/REC-SVG-20050904/DTD/svg11.dtd">\n<svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 490 370" preserveAspectRatio="xMidYMid meet">\n  <defs>\n  </defs>\n  <title>3x3x3</title>\n  <defs>\n    <g id="sticker">\n        <rect x="0" y="0" width="1" height="1" stroke="black" stroke-width="0.04px" />\n    </g>\n  </defs>\n\n\x3c!--        0 1 2 3 4 5 6 7 8 9 10 11  --\x3e\n\x3c!--        | | | | | | | | | | | |<-  --\x3e\n\x3c!--    0 -       . . .                --\x3e\n\x3c!--    1 -       . . .                --\x3e\n\x3c!--    2 -       . . .                --\x3e\n\x3c!--    3 - . . . . . . . . . . . .    --\x3e\n\x3c!--    4 - . . . . . . . . . . . .    --\x3e\n\x3c!--    5 - . . . . . . . . . . . .    --\x3e\n\x3c!--    6 -       . . .                --\x3e\n\x3c!--    7 -       . . .                --\x3e\n\x3c!--    8 -       . . .                --\x3e\n\n  <g id="puzzle" transform="translate(5, 5) scale(40)">\n    \x3c!-- CORNER --\x3e\n    <use id="CORNER-l0-o0" xlink:href="#sticker" transform="translate(5,  2)" style="fill: white"/>\n    <use id="CORNER-l0-o1" xlink:href="#sticker" transform="translate(6,  3)" style="fill: red"/>\n    <use id="CORNER-l0-o2" xlink:href="#sticker" transform="translate(5,  3)" style="fill: green"/>\n\n    <use id="CORNER-l1-o0" xlink:href="#sticker" transform="translate(5,  0)" style="fill: white"/>\n    <use id="CORNER-l1-o1" xlink:href="#sticker" transform="translate(9,  3)" style="fill: blue"/>\n    <use id="CORNER-l1-o2" xlink:href="#sticker" transform="translate(8,  3)" style="fill: red"/>\n\n    <use id="CORNER-l2-o0" xlink:href="#sticker" transform="translate(3,  0)" style="fill: white"/>\n    <use id="CORNER-l2-o1" xlink:href="#sticker" transform="translate(0,  3)" style="fill: orange"/>\n    <use id="CORNER-l2-o2" xlink:href="#sticker" transform="translate(11, 3)" style="fill: blue"/>\n\n    <use id="CORNER-l3-o0" xlink:href="#sticker" transform="translate(3,  2)" style="fill: white"/>\n    <use id="CORNER-l3-o1" xlink:href="#sticker" transform="translate(3,  3)" style="fill: green"/>\n    <use id="CORNER-l3-o2" xlink:href="#sticker" transform="translate(2,  3)" style="fill: orange"/>\n\n    <use id="CORNER-l4-o0" xlink:href="#sticker" transform="translate(5,  6)" style="fill: yellow"/>\n    <use id="CORNER-l4-o1" xlink:href="#sticker" transform="translate(5,  5)" style="fill: green"/>\n    <use id="CORNER-l4-o2" xlink:href="#sticker" transform="translate(6,  5)" style="fill: red"/>\n\n    <use id="CORNER-l5-o0" xlink:href="#sticker" transform="translate(3,  6)" style="fill: yellow"/>\n    <use id="CORNER-l5-o1" xlink:href="#sticker" transform="translate(2,  5)" style="fill: orange"/>\n    <use id="CORNER-l5-o2" xlink:href="#sticker" transform="translate(3,  5)" style="fill: green"/>\n\n    <use id="CORNER-l6-o0" xlink:href="#sticker" transform="translate(3,  8)" style="fill: yellow"/>\n    <use id="CORNER-l6-o1" xlink:href="#sticker" transform="translate(11, 5)" style="fill: blue"/>\n    <use id="CORNER-l6-o2" xlink:href="#sticker" transform="translate(0, 5)"  style="fill: orange"/>\n\n    <use id="CORNER-l7-o0" xlink:href="#sticker" transform="translate(5,  8)" style="fill: yellow"/>\n    <use id="CORNER-l7-o1" xlink:href="#sticker" transform="translate(8,  5)" style="fill: red"/>\n    <use id="CORNER-l7-o2" xlink:href="#sticker" transform="translate(9,  5)" style="fill: blue"/>\n\n    \x3c!-- EDGE --\x3e\n    <use id="EDGE-l0-o0"  xlink:href="#sticker" transform="translate(4,  2)" style="fill: white"/>\n    <use id="EDGE-l0-o1"  xlink:href="#sticker" transform="translate(4,  3)" style="fill: green"/>\n\n    <use id="EDGE-l1-o0"  xlink:href="#sticker" transform="translate(5,  1)" style="fill: white"/>\n    <use id="EDGE-l1-o1"  xlink:href="#sticker" transform="translate(7,  3)" style="fill: red"/>\n\n    <use id="EDGE-l2-o0"  xlink:href="#sticker" transform="translate(4,  0)" style="fill: white"/>\n    <use id="EDGE-l2-o1"  xlink:href="#sticker" transform="translate(10, 3)" style="fill: blue"/>\n\n    <use id="EDGE-l3-o0"  xlink:href="#sticker" transform="translate(3,  1)" style="fill: white"/>\n    <use id="EDGE-l3-o1"  xlink:href="#sticker" transform="translate(1,  3)" style="fill: orange"/>\n\n    <use id="EDGE-l4-o0"  xlink:href="#sticker" transform="translate(4,  6)" style="fill: yellow"/>\n    <use id="EDGE-l4-o1"  xlink:href="#sticker" transform="translate(4,  5)" style="fill: green"/>\n\n    <use id="EDGE-l5-o0" xlink:href="#sticker" transform="translate(5,  7)" style="fill: yellow"/>\n    <use id="EDGE-l5-o1" xlink:href="#sticker" transform="translate(7,  5)" style="fill: red"/>\n\n    <use id="EDGE-l6-o0" xlink:href="#sticker" transform="translate(4,  8)" style="fill: yellow"/>\n    <use id="EDGE-l6-o1" xlink:href="#sticker" transform="translate(10, 5)" style="fill: blue"/>\n\n    <use id="EDGE-l7-o0"  xlink:href="#sticker" transform="translate(3,  7)" style="fill: yellow"/>\n    <use id="EDGE-l7-o1"  xlink:href="#sticker" transform="translate(1,  5)" style="fill: orange"/>\n\n    <use id="EDGE-l8-o0"  xlink:href="#sticker" transform="translate(5,  4)" style="fill: green"/>\n    <use id="EDGE-l8-o1"  xlink:href="#sticker" transform="translate(6,  4)" style="fill: red"/>\n\n    <use id="EDGE-l9-o0"  xlink:href="#sticker" transform="translate(3,  4)" style="fill: green"/>\n    <use id="EDGE-l9-o1"  xlink:href="#sticker" transform="translate(2,  4)" style="fill: orange"/>\n\n    <use id="EDGE-l10-o0" xlink:href="#sticker" transform="translate(9,  4)" style="fill: blue"/>\n    <use id="EDGE-l10-o1" xlink:href="#sticker" transform="translate(8,  4)" style="fill: red"/>\n\n    <use id="EDGE-l11-o0" xlink:href="#sticker" transform="translate(11, 4)" style="fill: blue"/>\n    <use id="EDGE-l11-o1" xlink:href="#sticker" transform="translate(0,  4)" style="fill: orange"/>\n\n    \x3c!-- CENTER --\x3e\n    \x3c!-- TODO: Allow the same sticker to be reused for multiple orientations --\x3e\n    <use id="CENTER-l0-o0" xlink:href="#sticker" transform="translate(4,  1)" style="fill: white"/>\n    <use id="CENTER-l0-o1" xlink:href="#sticker" transform="translate(4,  1)" style="fill: white"/>\n    <use id="CENTER-l0-o2" xlink:href="#sticker" transform="translate(4,  1)" style="fill: white"/>\n    <use id="CENTER-l0-o3" xlink:href="#sticker" transform="translate(4,  1)" style="fill: white"/>\n\n    <use id="CENTER-l1-o0" xlink:href="#sticker" transform="translate(1,  4)" style="fill: orange"/>\n    <use id="CENTER-l1-o1" xlink:href="#sticker" transform="translate(1,  4)" style="fill: orange"/>\n    <use id="CENTER-l1-o2" xlink:href="#sticker" transform="translate(1,  4)" style="fill: orange"/>\n    <use id="CENTER-l1-o3" xlink:href="#sticker" transform="translate(1,  4)" style="fill: orange"/>\n\n    <use id="CENTER-l2-o0" xlink:href="#sticker" transform="translate(4,  4)" style="fill: green"/>\n    <use id="CENTER-l2-o1" xlink:href="#sticker" transform="translate(4,  4)" style="fill: green"/>\n    <use id="CENTER-l2-o2" xlink:href="#sticker" transform="translate(4,  4)" style="fill: green"/>\n    <use id="CENTER-l2-o3" xlink:href="#sticker" transform="translate(4,  4)" style="fill: green"/>\n\n    <use id="CENTER-l3-o0" xlink:href="#sticker" transform="translate(7,  4)" style="fill: red"/>\n    <use id="CENTER-l3-o1" xlink:href="#sticker" transform="translate(7,  4)" style="fill: red"/>\n    <use id="CENTER-l3-o2" xlink:href="#sticker" transform="translate(7,  4)" style="fill: red"/>\n    <use id="CENTER-l3-o3" xlink:href="#sticker" transform="translate(7,  4)" style="fill: red"/>\n\n    <use id="CENTER-l4-o0" xlink:href="#sticker" transform="translate(10, 4)" style="fill: blue"/>\n    <use id="CENTER-l4-o1" xlink:href="#sticker" transform="translate(10, 4)" style="fill: blue"/>\n    <use id="CENTER-l4-o2" xlink:href="#sticker" transform="translate(10, 4)" style="fill: blue"/>\n    <use id="CENTER-l4-o3" xlink:href="#sticker" transform="translate(10, 4)" style="fill: blue"/>\n\n    <use id="CENTER-l5-o0" xlink:href="#sticker" transform="translate(4,  7)" style="fill: yellow"/>\n    <use id="CENTER-l5-o1" xlink:href="#sticker" transform="translate(4,  7)" style="fill: yellow"/>\n    <use id="CENTER-l5-o2" xlink:href="#sticker" transform="translate(4,  7)" style="fill: yellow"/>\n    <use id="CENTER-l5-o3" xlink:href="#sticker" transform="translate(4,  7)" style="fill: yellow"/>\n  </g>\n\n</svg>\n'},pyram:{name:"pyram",orbits:{CENTERS:{numPieces:4,orientations:3},TIPS:{numPieces:4,orientations:3},EDGES:{numPieces:6,orientations:2}},startPieces:{CENTERS:{permutation:[0,1,2,3],orientation:[0,0,0,0]},TIPS:{permutation:[0,1,2,3],orientation:[0,0,0,0]},EDGES:{permutation:[0,1,2,3,4,5],orientation:[0,0,0,0,0,0]}},moves:{U:{CENTERS:{permutation:[0,1,2,3],orientation:[1,0,0,0]},TIPS:{permutation:[0,1,2,3],orientation:[1,0,0,0]},EDGES:{permutation:[1,2,0,3,4,5],orientation:[1,0,1,0,0,0]}},L:{CENTERS:{permutation:[0,1,2,3],orientation:[0,1,0,0]},TIPS:{permutation:[0,1,2,3],orientation:[0,1,0,0]},EDGES:{permutation:[5,1,2,0,4,3],orientation:[1,0,0,0,0,1]}},R:{CENTERS:{permutation:[0,1,2,3],orientation:[0,0,1,0]},TIPS:{permutation:[0,1,2,3],orientation:[0,0,1,0]},EDGES:{permutation:[0,3,2,4,1,5],orientation:[0,0,0,1,1,0]}},B:{CENTERS:{permutation:[0,1,2,3],orientation:[0,0,0,1]},TIPS:{permutation:[0,1,2,3],orientation:[0,0,0,1]},EDGES:{permutation:[0,1,4,3,5,2],orientation:[0,0,0,0,1,1]}},u:{CENTERS:{permutation:[0,1,2,3],orientation:[0,0,0,0]},TIPS:{permutation:[0,1,2,3],orientation:[1,0,0,0]},EDGES:{permutation:[0,1,2,3,4,5],orientation:[0,0,0,0,0,0]}},l:{CENTERS:{permutation:[0,1,2,3],orientation:[0,0,0,0]},TIPS:{permutation:[0,1,2,3],orientation:[0,1,0,0]},EDGES:{permutation:[0,1,2,3,4,5],orientation:[0,0,0,0,0,0]}},r:{CENTERS:{permutation:[0,1,2,3],orientation:[0,0,0,0]},TIPS:{permutation:[0,1,2,3],orientation:[0,0,1,0]},EDGES:{permutation:[0,1,2,3,4,5],orientation:[0,0,0,0,0,0]}},b:{CENTERS:{permutation:[0,1,2,3],orientation:[0,0,0,0]},TIPS:{permutation:[0,1,2,3],orientation:[0,0,0,1]},EDGES:{permutation:[0,1,2,3,4,5],orientation:[0,0,0,0,0,0]}}},svg:'<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.0//EN"\n       "http://www.w3.org/TR/2001/REC-SVG-20050904/DTD/svg11.dtd">\n<svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 490 420.69219392" preserveAspectRatio="xMidYMid meet">\n  <defs>\n  </defs>\n  <title>2x2x2</title>\n  <defs>\n    <g id="stickerA" transform="scale(1, 0.577350269)">\n      <path\n         d="m 0,1.732050808 1,-1.732050808 1,1.732050808 z"\n         stroke="black" stroke-width="0.04px" stroke-linecap="butt" stroke-linejoin="round"\n      />\n    </g>\n    <g id="stickerV" transform="scale(1, 0.577350269)">\n      <path\n         d="m 0,0 1,1.732050808 1,-1.732050808 z"\n         stroke="black" stroke-width="0.04px" stroke-linecap="butt" stroke-linejoin="round"\n      />\n    </g>\n  </defs>\n\n\x3c!--        0 1 2 3 4 5 6 7 8 9 10   --\x3e\n\x3c!--        | | | | | | | | | | |    --\x3e\n\x3c!--    0 - L L L L L F R R R R R    --\x3e\n\x3c!--    1 -   L L L F F F R R R      --\x3e\n\x3c!--    2 -     L F F F F F R        --\x3e\n\x3c!--    3 -       D D D D D          --\x3e\n\x3c!--    4 -         D D D            --\x3e\n\x3c!--    5 -           D              --\x3e\n\n  <g id="puzzle" transform="translate(5, 5) scale(40, 69.28203232)">\n    \x3c!-- CENTERS --\x3e\n    <use id="CENTERS-l0-o0" xlink:href="#stickerV" transform="translate(5, 1)" style="fill: yellow"/>\n    <use id="CENTERS-l0-o1" xlink:href="#stickerA" transform="translate(3, 0)" style="fill: blue"/>\n    <use id="CENTERS-l0-o2" xlink:href="#stickerA" transform="translate(7, 0)" style="fill: red"/>\n\n    <use id="CENTERS-l1-o0" xlink:href="#stickerV" transform="translate(4, 2)" style="fill: yellow"/>\n    <use id="CENTERS-l1-o1" xlink:href="#stickerA" transform="translate(4, 3)" style="fill: green"/>\n    <use id="CENTERS-l1-o2" xlink:href="#stickerA" transform="translate(2, 1)" style="fill: blue"/>\n\n    <use id="CENTERS-l2-o0" xlink:href="#stickerV" transform="translate(6, 2)" style="fill: yellow"/>\n    <use id="CENTERS-l2-o1" xlink:href="#stickerA" transform="translate(8, 1)" style="fill: red"/>\n    <use id="CENTERS-l2-o2" xlink:href="#stickerA" transform="translate(6, 3)" style="fill: green"/>\n\n    <use id="CENTERS-l3-o0" xlink:href="#stickerA" transform="translate(9, 0)" style="fill: red"/>\n    <use id="CENTERS-l3-o1" xlink:href="#stickerA" transform="translate(1, 0)" style="fill: blue"/>\n    <use id="CENTERS-l3-o2" xlink:href="#stickerA" transform="translate(5, 4)" style="fill: green"/>\n\n    \x3c!-- TIPS --\x3e\n    <use id="TIPS-l0-o0" xlink:href="#stickerA" transform="translate(5, 0)" style="fill: yellow"/>\n    <use id="TIPS-l0-o1" xlink:href="#stickerV" transform="translate(4, 0)" style="fill: blue"/>\n    <use id="TIPS-l0-o2" xlink:href="#stickerV" transform="translate(6, 0)" style="fill: red"/>\n\n    <use id="TIPS-l1-o0" xlink:href="#stickerA" transform="translate(3, 2)" style="fill: yellow"/>\n    <use id="TIPS-l1-o1" xlink:href="#stickerV" transform="translate(3, 3)" style="fill: green"/>\n    <use id="TIPS-l1-o2" xlink:href="#stickerV" transform="translate(2, 2)" style="fill: blue"/>\n\n    <use id="TIPS-l2-o0" xlink:href="#stickerV" transform="translate(8, 2)" style="fill: red"/>\n    <use id="TIPS-l2-o1" xlink:href="#stickerV" transform="translate(7, 3)" style="fill: green"/>\n    <use id="TIPS-l2-o2" xlink:href="#stickerA" transform="translate(7, 2)" style="fill: yellow"/>\n\n    <use id="TIPS-l3-o0" xlink:href="#stickerV" transform="translate(10,0)" style="fill: red"/>\n    <use id="TIPS-l3-o1" xlink:href="#stickerV" transform="translate(0, 0)" style="fill: blue"/>\n    <use id="TIPS-l3-o2" xlink:href="#stickerV" transform="translate(5, 5)" style="fill: green"/>\n\n    \x3c!-- EDGES --\x3e\n    <use id="EDGES-l0-o0" xlink:href="#stickerA" transform="translate(4, 1)" style="fill: yellow"/>\n    <use id="EDGES-l0-o1" xlink:href="#stickerV" transform="translate(3, 1)" style="fill: blue"/>\n\n    <use id="EDGES-l1-o0" xlink:href="#stickerA" transform="translate(6, 1)" style="fill: yellow"/>\n    <use id="EDGES-l1-o1" xlink:href="#stickerV" transform="translate(7, 1)" style="fill: red"/>\n\n    <use id="EDGES-l2-o0" xlink:href="#stickerV" transform="translate(8, 0)" style="fill: red"/>\n    <use id="EDGES-l2-o1" xlink:href="#stickerV" transform="translate(2, 0)" style="fill: blue"/>\n\n    <use id="EDGES-l3-o0" xlink:href="#stickerV" transform="translate(5, 3)" style="fill: green"/>\n    <use id="EDGES-l3-o1" xlink:href="#stickerA" transform="translate(5, 2)" style="fill: yellow"/>\n\n    <use id="EDGES-l4-o0" xlink:href="#stickerV" transform="translate(6, 4)" style="fill: green"/>\n    <use id="EDGES-l4-o1" xlink:href="#stickerV" transform="translate(9, 1)" style="fill: red"/>\n\n    <use id="EDGES-l5-o0" xlink:href="#stickerV" transform="translate(4, 4)" style="fill: green"/>\n    <use id="EDGES-l5-o1" xlink:href="#stickerV" transform="translate(1, 1)" style="fill: blue"/>\n  </g>\n\n</svg>'},sq1:{name:"sq1",orbits:{WEDGE:{numPieces:24,orientations:9},EQUATOR:{numPieces:2,orientations:6}},startPieces:{WEDGE:{permutation:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],orientation:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},EQUATOR:{permutation:[0,1],orientation:[0,0]}},moves:{U:{WEDGE:{permutation:[11,0,1,2,3,4,5,6,7,8,9,10,12,13,14,15,16,17,18,19,20,21,22,23],orientation:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},EQUATOR:{permutation:[0,1],orientation:[0,0]}},D:{WEDGE:{permutation:[0,1,2,3,4,5,6,7,8,9,10,11,23,12,13,14,15,16,17,18,19,20,21,22],orientation:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},EQUATOR:{permutation:[0,1],orientation:[0,0]}},SLICE:{WEDGE:{permutation:[0,1,2,3,4,5,12,13,14,15,16,17,6,7,8,9,10,11,18,19,20,21,22,23],orientation:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},EQUATOR:{permutation:[0,1],orientation:[0,3]}}},svg:n.readFileSync(__dirname+"/sq1.svg","utf-8")}};var X=function(){function e(t,n,r,i){this.message=t,this.expected=n,this.found=r,this.location=i,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}return function(e,t){function n(){this.constructor=e}n.prototype=t.prototype,e.prototype=new n}(e,Error),e.buildMessage=function(e,t){var n={literal:function(e){return'"'+i(e.text)+'"'},class:function(e){var t,n="";for(t=0;t<e.parts.length;t++)n+=e.parts[t]instanceof Array?o(e.parts[t][0])+"-"+o(e.parts[t][1]):o(e.parts[t]);return"["+(e.inverted?"^":"")+n+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};function r(e){return e.charCodeAt(0).toString(16).toUpperCase()}function i(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+r(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+r(e)}))}function o(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+r(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+r(e)}))}return"Expected "+function(e){var t,r,i,o=new Array(e.length);for(t=0;t<e.length;t++)o[t]=(i=e[t],n[i.type](i));if(o.sort(),o.length>0){for(t=1,r=1;t<o.length;t++)o[t-1]!==o[t]&&(o[r]=o[t],r++);o.length=r}switch(o.length){case 1:return o[0];case 2:return o[0]+" or "+o[1];default:return o.slice(0,-1).join(", ")+", or "+o[o.length-1]}}(e)+" but "+function(e){return e?'"'+i(e)+'"':"end of input"}(t)+" found."},{SyntaxError:e,parse:function(t,n){n=void 0!==n?n:{};var r,i,o,s,a={},l={start:z},u=z,c=function(e){return function(e){for(const t in e.moves){const n=e.moves[t];for(const t in e.orbits){const e=n[t],r=e.orientation,i=e.permutation,o=new Array(r.length);for(let e=0;e<i.length;e++)o[e]=r[i[e]];e.orientation=o}}return e}(e)},f=/^[A-Za-z0-9<>]/,h=U([["A","Z"],["a","z"],["0","9"],"<",">"],!1,!1),m=/^[A-Za-z]/,d=U([["A","Z"],["a","z"]],!1,!1),p=/^[A-Za-z0-9]/,v=U([["A","Z"],["a","z"],["0","9"]],!1,!1),E=/^[0-9]/,y=U([["0","9"]],!1,!1),g=L(" ",!1),w=L("Name",!1),x=L("Set",!1),C=L("\n",!1),k=L("Solved",!1),S=L("End",!1),R=L("Move",!1),A=0,b=[{line:1,column:1}],N=0,T=[];if("startRule"in n){if(!(n.startRule in l))throw new Error("Can't start parsing from rule \""+n.startRule+'".');u=l[n.startRule]}function L(e,t){return{type:"literal",text:e,ignoreCase:t}}function U(e,t,n){return{type:"class",parts:e,inverted:t,ignoreCase:n}}function D(e){var n,r=b[e];if(r)return r;for(n=e-1;!b[n];)n--;for(r={line:(r=b[n]).line,column:r.column};n<e;)10===t.charCodeAt(n)?(r.line++,r.column=1):r.column++,n++;return b[e]=r,r}function M(e,t){var n=D(e),r=D(t);return{start:{offset:e,line:n.line,column:n.column},end:{offset:t,line:r.line,column:r.column}}}function G(e){A<N||(A>N&&(N=A,T=[]),T.push(e))}function z(){var e;return A,(e=function(){var e,n,r,i,o;e=A,(n=function(){var e,n,r;e=A,"Name"===t.substr(A,4)?(n="Name",A+=4):(n=a,G(w));n!==a&&O()!==a&&(r=P())!==a?e=n=r:(A=e,e=a);return e}())!==a&&I()!==a&&(r=function e(){var t,n,r;t=A,(n=F())!==a&&V()!==a&&(r=e())!==a?((o=r)[(i=n)[0]]=i[1],t=n=o):(A=t,t=a);var i,o;t===a&&(t=A,(n=F())!==a&&(n=function(e){const t={};return t[e[0]]=e[1],t}(n)),t=n);return t}())!==a&&I()!==a&&(i=function(){var e,n,r,i;e=A,"Solved"===t.substr(A,6)?(n="Solved",A+=6):(n=a,G(k));n!==a&&V()!==a&&(r=K())!==a&&V()!==a?("End"===t.substr(A,3)?(i="End",A+=3):(i=a,G(S)),i!==a?e=n=r:(A=e,e=a)):(A=e,e=a);return e}())!==a&&I()!==a&&(o=function e(){var t,n,r;t=A,(n=_())!==a&&I()!==a&&(r=e())!==a?((o=r)[(i=n)[0]]=i[1],t=n=o):(A=t,t=a);var i,o;t===a&&(t=A,(n=_())!==a&&(n=function(e){const t={};return t[e[0]]=e[1],t}(n)),t=n);return t}())!==a&&function(){var e,n;e=[],10===t.charCodeAt(A)?(n="\n",A++):(n=a,G(C));for(;n!==a;)e.push(n),10===t.charCodeAt(A)?(n="\n",A++):(n=a,G(C));return e}()!==a?e=n={name:n,orbits:r,moves:o,startPieces:i}:(A=e,e=a);return e}())!==a&&(e=c(e)),e}function P(){var e,n;if(A,e=[],f.test(t.charAt(A))?(n=t.charAt(A),A++):(n=a,G(h)),n!==a)for(;n!==a;)e.push(n),f.test(t.charAt(A))?(n=t.charAt(A),A++):(n=a,G(h));else e=a;return e!==a&&(e=e.join("")),e}function q(){var e,n,r,i;if(e=A,m.test(t.charAt(A))?(n=t.charAt(A),A++):(n=a,G(d)),n!==a){for(r=[],p.test(t.charAt(A))?(i=t.charAt(A),A++):(i=a,G(v));i!==a;)r.push(i),p.test(t.charAt(A))?(i=t.charAt(A),A++):(i=a,G(v));r!==a?e=n=[n].concat(r).join(""):(A=e,e=a)}else A=e,e=a;return e}function B(){var e,n;if(A,e=[],E.test(t.charAt(A))?(n=t.charAt(A),A++):(n=a,G(y)),n!==a)for(;n!==a;)e.push(n),E.test(t.charAt(A))?(n=t.charAt(A),A++):(n=a,G(y));else e=a;return e!==a&&(e=parseInt(e.join(""),10)),e}function O(){var e;return 32===t.charCodeAt(A)?(e=" ",A++):(e=a,G(g)),e}function F(){var e,n,r,i,o;return e=A,"Set"===t.substr(A,3)?(n="Set",A+=3):(n=a,G(x)),n!==a&&O()!==a&&(r=q())!==a&&O()!==a&&(i=B())!==a&&O()!==a&&(o=B())!==a?e=n=[r,{numPieces:i,orientations:o}]:(A=e,e=a),e}function V(){var e;return 10===t.charCodeAt(A)?(e="\n",A++):(e=a,G(C)),e}function I(){var e,n;if(e=[],10===t.charCodeAt(A)?(n="\n",A++):(n=a,G(C)),n!==a)for(;n!==a;)e.push(n),10===t.charCodeAt(A)?(n="\n",A++):(n=a,G(C));else e=a;return e}function j(){var e,t,n;return e=A,(t=B())!==a&&O()!==a&&(n=j())!==a?e=t=[t].concat(n):(A=e,e=a),e===a&&(e=A,(t=B())!==a&&(t=function(e){return[e]}(t)),e=t),e}function Q(){var e;return A,(e=j())!==a&&(e=e.map(e=>e-1)),e}function $(){var e,t,n,r;return e=A,(t=q())!==a&&V()!==a&&(n=Q())!==a&&V()!==a&&(r=j())!==a?e=t=[t,{permutation:n,orientation:r}]:(A=e,e=a),e===a&&(e=A,(t=q())!==a&&V()!==a&&(n=Q())!==a?e=t=function(e,t){return[e,{permutation:t,orientation:new Array(t.length).fill(0)}]}(t,n):(A=e,e=a)),e}function K(){var e,t,n,r,i;return e=A,(t=$())!==a&&V()!==a&&(n=K())!==a?((i=n)[(r=t)[0]]=r[1],e=t=i):(A=e,e=a),e===a&&(e=A,(t=$())!==a&&(t=function(e){const t={};return t[e[0]]=e[1],t}(t)),e=t),e}function _(){var e,n,r,i,o;return e=A,"Move"===t.substr(A,4)?(n="Move",A+=4):(n=a,G(R)),n!==a&&O()!==a&&(r=P())!==a&&V()!==a&&(i=K())!==a&&V()!==a?("End"===t.substr(A,3)?(o="End",A+=3):(o=a,G(S)),o!==a?e=n=[r,i]:(A=e,e=a)):(A=e,e=a),e}if((r=u())!==a&&A===t.length)return r;throw r!==a&&A<t.length&&G({type:"end"}),i=T,o=N<t.length?t.charAt(N):null,s=N<t.length?M(N,N+1):M(N,N),new e(e.buildMessage(i,o),i,o,s)}}}();const{parse:ee}=X,te="http://www.w3.org/2000/svg";let ne=0;var re=Object.freeze({__proto__:null,Combine:$,Multiply:K,IdentityTransformation:_,Invert:W,EquivalentTransformations:H,KPuzzle:KPuzzle,EquivalentStates:function(e,t,n){return H(e,$(e,e.startPieces,t),$(e,e.startPieces,n))},stateForBlockMove:Y,Order:function(e,t){let n=1;for(const r in e.orbits){const i=e.orbits[r],o=t[r],s=new Array(i.numPieces);for(let e=0;e<i.numPieces;e++)if(!s[e]){let t=e,r=0,a=0;for(;s[t]=!0,r+=o.orientation[t],a+=1,t=o.permutation[t],t!==e;);0!==r&&(a=a*i.orientations/Z(i.orientations,r)),n=n*a/Z(n,a)}}return n},Puzzles:J,parse:ee,SVG:class SVG{constructor(e){if(this.kPuzzleDefinition=e,this.originalColors={},this.gradients={},!e.svg)throw new Error(`No SVG definition for puzzle type: ${e.name}`);this.svgID=(ne+=1,"svg"+ne.toString()),this.element=document.createElement("div"),this.element.classList.add("svg-wrapper"),this.element.innerHTML=e.svg;const t=this.element.querySelector("svg");if(!t)throw new Error("Could not get SVG element");if(te!==t.namespaceURI)throw new Error("Unexpected XML namespace");this.gradientDefs=document.createElementNS(te,"defs"),t.insertBefore(this.gradientDefs,t.firstChild);for(const t in e.orbits){const n=e.orbits[t];for(let e=0;e<n.numPieces;e++)for(let r=0;r<n.orientations;r++){const n=this.elementID(t,e,r),i=this.elementByID(n),o=i.style.fill;this.originalColors[n]=o,this.gradients[n]=this.newGradient(n,o),this.gradientDefs.appendChild(this.gradients[n]),i.setAttribute("style",`fill: url(#grad-${this.svgID}-${n})`)}}}draw(e,t,n,r){for(const i in e.orbits){const o=e.orbits[i],s=t[i],a=n?n[i]:null;for(let e=0;e<o.numPieces;e++)for(let t=0;t<o.orientations;t++){const n=this.elementID(i,e,t),l=this.elementID(i,s.permutation[e],(o.orientations-s.orientation[e]+t)%o.orientations);let u=!1;if(a){const s=this.elementID(i,a.permutation[e],(o.orientations-a.orientation[e]+t)%o.orientations);l===s&&(u=!0);const c=100*(1-(r=r||0)*r*(2-r*r));this.gradients[n].children[0].setAttribute("stop-color",this.originalColors[l]),this.gradients[n].children[1].setAttribute("stop-color",this.originalColors[l]),this.gradients[n].children[1].setAttribute("offset",`${Math.max(c-5,0)}%`),this.gradients[n].children[2].setAttribute("offset",`${Math.max(c-5,0)}%`),this.gradients[n].children[3].setAttribute("offset",`${c}%`),this.gradients[n].children[4].setAttribute("offset",`${c}%`),this.gradients[n].children[4].setAttribute("stop-color",this.originalColors[s]),this.gradients[n].children[5].setAttribute("stop-color",this.originalColors[s])}else u=!0;u&&(this.gradients[n].children[0].setAttribute("stop-color",this.originalColors[l]),this.gradients[n].children[1].setAttribute("stop-color",this.originalColors[l]),this.gradients[n].children[1].setAttribute("offset","100%"),this.gradients[n].children[2].setAttribute("offset","100%"),this.gradients[n].children[3].setAttribute("offset","100%"),this.gradients[n].children[4].setAttribute("offset","100%"))}}}newGradient(e,t){const n=document.createElementNS(te,"radialGradient");n.setAttribute("id",`grad-${this.svgID}-${e}`),n.setAttribute("r","70.7107%");const r=[{offset:0,color:t},{offset:0,color:t},{offset:0,color:"black"},{offset:0,color:"black"},{offset:0,color:t},{offset:100,color:t}];for(const e of r){const t=document.createElementNS(te,"stop");t.setAttribute("offset",`${e.offset}%`),t.setAttribute("stop-color",e.color),t.setAttribute("stop-opacity","1"),n.appendChild(t)}return n}elementID(e,t,n){return e+"-l"+t+"-o"+n}elementByID(e){return this.element.querySelector("#"+e)}}});function ie(e){switch(Math.max(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z))){case e.x:return"x";case-e.x:return"-x";case e.y:return"y";case-e.y:return"-y";case e.z:return"z";case-e.z:return"-z";default:throw new Error("Uh-oh.")}}const oe=Math.sqrt(.5),se={"y z":new t.Quaternion(0,0,0,1),"-z y":new t.Quaternion(oe,0,0,oe),"x z":new t.Quaternion(0,0,-oe,oe),"-x z":new t.Quaternion(0,0,oe,oe)};class BasicRotationTransformer{transformMove(e){}transformOrientation(e){const{x:n,y:r,z:i,w:o}=e.quaternion,s=new t.Quaternion(n,r,i,o),a=new t.Vector3(0,1,0),l=new t.Vector3(0,0,1),u=ie(a.applyQuaternion(s)),c=ie(l.applyQuaternion(s)),f=se[`${u} ${c}`]||se["y z"];console.log(s),console.log(f);const h=s.premultiply(f);console.log(h),e.quaternion={x:h.x,y:h.y,z:h.z,w:h.w},console.log(e.quaternion)}}class BluetoothPuzzle{constructor(){this.transformers=[],this.listeners=[],this.orientationListeners=[]}getState(){return Q(this,void 0,void 0,(function*(){throw new Error("cannot get state")}))}addMoveListener(e){this.listeners.push(e)}addOrientationListener(e){this.orientationListeners.push(e)}experimentalAddBasicRotationTransformer(){this.transformers.push(new BasicRotationTransformer)}dispatchMove(e){for(const t of this.transformers)t.transformMove(e);for(const t of this.listeners)t(e)}dispatchOrientation(e){for(const t of this.transformers)t.transformOrientation(e);for(const t of this.orientationListeners)t(e)}}let ae=!0;function le(...e){ae&&(console.info?console.info.apply(console,e):console.log.apply(console,e))}const ue=new Uint8Array(16),ce=new Uint8Array(new Array(16).fill(16));function fe(e,t){return Q(this,void 0,void 0,(function*(){const n=yield function(e,t,n){return Q(this,void 0,void 0,(function*(){return(yield window.crypto.subtle.encrypt({name:"AES-CBC",iv:n},e,t)).slice(0,16)}))}(e,ce,t),r=new Uint8Array(32);return r.set(new Uint8Array(t),0),r.set(new Uint8Array(n),16),(yield window.crypto.subtle.decrypt({name:"AES-CBC",iv:ue},e,r)).slice(0,16)}))}const he={0:c("U"),2:c("U",-1),3:c("R"),5:c("R",-1),6:c("F"),8:c("F",-1),9:c("D"),11:c("D",-1),12:c("L"),14:c("L",-1),15:c("B"),17:c("B",-1)};let me=null,de=(e,t,n)=>[-t,n,-e];function pe(e){return e[13]<18&&e[14]<18&&e[15]<18&&e[16]<18&&e[17]<18&&e[18]<18}window.setSwap=e=>{de=e,me=null};const ve=new Uint8Array([198,202,21,223,79,110,19,182,119,13,230,89,58,175,186,162]);new Uint8Array([67,226,91,214,125,220,120,216,7,96,163,218,130,60,1,241]);function Ee(e,t,n){return Q(this,void 0,void 0,(function*(){const t=new Uint8Array(ve);for(let e=0;e<n.length;e++)t[e]=(t[e]+n[e])%256;const r=yield function(e){return Q(this,void 0,void 0,(function*(){return yield crypto.subtle.importKey("raw",e,"AES-CBC",!0,["encrypt","decrypt"])}))}(new Uint8Array(t));return e.set(new Uint8Array(yield fe(r,e.slice(3))),3),e.set(new Uint8Array(yield fe(r,e.slice(0,16))),0),e}))}function ye(e,t){return Q(this,void 0,void 0,(function*(){if(pe(e))return e;const n=yield Ee(e,0,t);if(pe(n))return n;const r=yield Ee(e,0,t);if(pe(r))return r;throw new Error("Unable to decode")}))}class PhysicalState{constructor(e,t){if(this.dataView=e,this.timeStamp=t,this.arrLen=19,this.arr=new Uint8Array(e.buffer),this.arr.length!==this.arrLen)throw new Error("Unexpected array length")}static read(e,t){return Q(this,void 0,void 0,(function*(){const n=yield ye(new Uint8Array((yield e.readValue()).buffer),t),r=Date.now();return new PhysicalState(new DataView(n.buffer),r)}))}rotQuat(){let e=this.dataView.getInt16(0,!0)/16384,n=this.dataView.getInt16(2,!0)/16384,r=this.dataView.getInt16(4,!0)/16384;[e,n,r]=de(e,n,r);const i=1-(e*e+n*n+r*r),o=i>0?Math.sqrt(i):0,s=new t.Quaternion(e,n,r,o);return me||(me=s.clone().inverse()),s.clone().multiply(me.clone())}moveCounter(){return this.arr[12]}numMovesSince(e){return this.moveCounter()-e&255}latestMoves(e){if(e<0||e>6)throw new Error(`Must ask for 0 to 6 latest moves. (Asked for ${e})`);return Array.from(this.arr.slice(19-e,19)).map(e=>he[e])}debugInfo(){return{arr:this.arr}}}const ge="0000fff0-0000-1000-8000-00805f9b34fb",we="0000fff5-0000-1000-8000-00805f9b34fb",xe="0000fff7-0000-1000-8000-00805f9b34fb",Ce="0000fff2-0000-1000-8000-00805f9b34fb",ke="0000fff3-0000-1000-8000-00805f9b34fb",Se={reset:new Uint8Array([0,0,36,0,73,146,36,73,109,146,219,182,73,146,182,36,109,219])},Re={filters:[{namePrefix:"GAN"}],optionalServices:[ge]};const Ae="UF UR UB UL DF DR DB DL FR FL BR BL".split(" "),be="UFR URB UBL ULF DRF DFL DLB DBR".split(" ");function Ne(e,t){return e.slice(t)+e.slice(0,t)}const Te={};Ae.forEach((e,t)=>{for(let n=0;n<2;n++)Te[Ne(e,n)]={piece:t,orientation:n}}),be.forEach((e,t)=>{for(let n=0;n<3;n++)Te[Ne(e,n)]={piece:t,orientation:n}});const Le=[[0,21,15],[5,13,47],[7,45,39],[2,37,23],[29,10,16],[31,18,32],[26,34,40],[24,42,8]],Ue=[[1,22],[3,14],[6,46],[4,38],[30,17],[27,9],[25,41],[28,33],[19,12],[20,35],[44,11],[43,36]];class GanCube extends BluetoothPuzzle{constructor(e,t,n,r,i){super(),this.service=e,this.server=t,this.physicalStateCharacteristic=n,this.lastMoveCounter=r,this.macAddress=i,this.INTERVAL_MS=150,this.intervalHandle=null,this.kpuzzle=new KPuzzle(J["3x3x3"]),this.startTrackingMoves()}static connect(e){return Q(this,void 0,void 0,(function*(){const t=function(e){const t=new Uint8Array([76,36,152,0,0,0]);return 10===e.length&&e.startsWith("GAN-")||console.warn("Unexpected puzzle name."),t[3]=parseInt(e.slice(4,6),16),t[4]=parseInt(e.slice(6,8),16),t[5]=parseInt(e.slice(8,10),16),t}(e.device.name),n=yield e.getPrimaryService(ge);le("Service:",n);const r=yield n.getCharacteristic(we);le("Characteristic:",r);const i=(yield PhysicalState.read(r,t)).moveCounter();return le("Initial Move Counter:",i),new GanCube(n,e,r,i,t)}))}name(){return this.server.device.name}startTrackingMoves(){this.intervalHandle=window.setInterval(this.intervalHandler.bind(this),this.INTERVAL_MS)}stopTrackingMoves(){if(!this.intervalHandle)throw new Error("Not tracking moves!");clearInterval(this.intervalHandle),this.intervalHandle=null}intervalHandler(){return Q(this,void 0,void 0,(function*(){const e=yield PhysicalState.read(this.physicalStateCharacteristic,this.macAddress);let t=e.numMovesSince(this.lastMoveCounter);t>6&&(le(`Too many moves! Dropping ${t-6} moves`),t=6);for(const n of e.latestMoves(t))this.kpuzzle.applyBlockMove(n),this.dispatchMove({latestMove:n,timeStamp:e.timeStamp,debug:e.debugInfo(),state:this.kpuzzle.state});const{x:n,y:r,z:i,w:o}=e.rotQuat();this.dispatchOrientation({timeStamp:e.timeStamp,quaternion:{x:n,y:r,z:i,w:o}}),this.lastMoveCounter=e.moveCounter()}))}getBattery(){return Q(this,void 0,void 0,(function*(){return new Uint8Array(yield this.readActualAngleAndBatteryCharacteristic())[7]}))}getState(){return Q(this,void 0,void 0,(function*(){const e=yield ye(new Uint8Array(yield this.readFaceletStatus1Characteristic()),this.macAddress),t=[];for(let n=0;n<18;n+=3){let r=((e[1^n]<<8)+e[n+1^1]<<8)+e[n+2^1];for(let e=0;e<8;e++)t.push(7&r),r>>=3}const n={CORNER:{permutation:[],orientation:[]},EDGE:{permutation:[],orientation:[]},CENTER:{permutation:[0,1,2,3,4,5],orientation:[0,0,0,0,0,0]}};for(const e of Le){const r=Te[e.map(e=>"URFDLB"[t[e]]).join("")];n.CORNER.permutation.push(r.piece),n.CORNER.orientation.push(r.orientation)}for(const e of Ue){const r=Te[e.map(e=>"URFDLB"[t[e]]).join("")];n.EDGE.permutation.push(r.piece),n.EDGE.orientation.push(r.orientation)}return n}))}faceletStatus1Characteristic(){return Q(this,void 0,void 0,(function*(){return this.cachedFaceletStatus1Characteristic=this.cachedFaceletStatus1Characteristic||this.service.getCharacteristic(Ce),this.cachedFaceletStatus1Characteristic}))}faceletStatus2Characteristic(){return Q(this,void 0,void 0,(function*(){return this.cachedFaceletStatus2Characteristic=this.cachedFaceletStatus2Characteristic||this.service.getCharacteristic(ke),this.cachedFaceletStatus2Characteristic}))}actualAngleAndBatteryCharacteristic(){return Q(this,void 0,void 0,(function*(){return this.cachedActualAngleAndBatteryCharacteristic=this.cachedActualAngleAndBatteryCharacteristic||this.service.getCharacteristic(xe),this.cachedActualAngleAndBatteryCharacteristic}))}reset(){return Q(this,void 0,void 0,(function*(){const e=yield this.faceletStatus1Characteristic();yield e.writeValue(Se.reset)}))}readFaceletStatus1Characteristic(){return Q(this,void 0,void 0,(function*(){const e=yield this.faceletStatus1Characteristic();return(yield e.readValue()).buffer}))}readFaceletStatus2Characteristic(){return Q(this,void 0,void 0,(function*(){const e=yield this.faceletStatus2Characteristic();return t=(yield e.readValue()).buffer,Array.prototype.map.call(new Uint8Array(t),e=>("00"+e.toString(16)).slice(-2)).join(" ");var t}))}readActualAngleAndBatteryCharacteristic(){return Q(this,void 0,void 0,(function*(){const e=yield this.actualAngleAndBatteryCharacteristic();return(yield e.readValue()).buffer}))}}const De="0000aadb-0000-1000-8000-00805f9b34fb",Me="0000aadc-0000-1000-8000-00805f9b34fb",Ge={filters:[{namePrefix:"Gi"},{services:["0000aadb-0000-1000-8000-00805f9b34fb"]},{services:["0000aaaa-0000-1000-8000-00805f9b34fb"]},{services:["0000fe95-0000-1000-8000-00805f9b34fb"]}],optionalServices:[De]};function ze(e,t){return 9===t&&(le("Encountered 9",e,t),t=2),c(["?","B","D","L","U","R","F"][e],t=[0,1,2,-1][t])}const Pe={permutation:[0,1,2,3,4,5],orientation:[0,0,0,0,0,0]},qe=[4,8,0,9,5,1,3,7,6,10,2,11],Be=[2,5,10,6,0,4,8,7,1,3,9,11],Oe=[1,0,1,0,1,0,1,0,0,0,0,0],Fe=[1,0,1,0,1,0,1,0,0,0,0,0],Ve=[4,0,3,5,7,1,2,6],Ie=[1,5,6,2,0,3,7,4],je=[1,2,1,2,2,1,2,1],Qe=[2,1,2,1,1,2,1,2],$e=[-1,1,-1,1,1,-1,1,-1];function Ke(e,t){return t%2==1?e[t/2|0]%16:0|e[t/2|0]/16}const _e=[176,81,104,224,86,137,237,119,38,26,193,161,210,126,150,81,93,13,236,249,89,235,88,24,113,81,214,131,130,199,2,169,39,165,171,41];function We(e){return Q(this,void 0,void 0,(function*(){return function(e){return 167===e[18]}(e)?yield function(e){const t=Ke(e,38),n=Ke(e,39),r=new Uint8Array(20);for(let i=0;i<20;i++)r[i]=e[i]+_e[t+i]+_e[n+i];return r}(e):e}))}class GiiKERCube extends BluetoothPuzzle{constructor(e,t,n){super(),this.server=e,this.cubeCharacteristic=t,this.originalValue=n}static connect(e){return Q(this,void 0,void 0,(function*(){const t=yield e.getPrimaryService(De);le("Service:",t);const n=yield t.getCharacteristic(Me);le("Characteristic:",n);const r=yield We(new Uint8Array((yield n.readValue()).buffer));le("Original value:",r);const i=new GiiKERCube(e,n,r);return yield n.startNotifications(),n.addEventListener("characteristicvaluechanged",i.onCubeCharacteristicChanged.bind(i)),i}))}name(){return this.server.device.name}getState(){return Q(this,void 0,void 0,(function*(){return this.toReid333(new Uint8Array((yield this.cubeCharacteristic.readValue()).buffer))}))}getBit(e,t){const n=7-t%8;return e[t/8|0]>>n&1}toReid333(e){const t={EDGE:{permutation:new Array(12),orientation:new Array(12)},CORNER:{permutation:new Array(8),orientation:new Array(8)},CENTER:Pe};for(let n=0;n<12;n++){const r=Be[n];t.EDGE.permutation[n]=qe[Ke(e,r+16)-1],t.EDGE.orientation[n]=this.getBit(e,r+112)^Oe[t.EDGE.permutation[n]]^Fe[n]}for(let n=0;n<8;n++){const r=Ie[n];t.CORNER.permutation[n]=Ve[Ke(e,r)-1],t.CORNER.orientation[n]=(Ke(e,r+8)*$e[r]+je[t.CORNER.permutation[n]]+Qe[n])%3}return t}onCubeCharacteristicChanged(e){return Q(this,void 0,void 0,(function*(){const t=yield We(new Uint8Array(e.target.value.buffer));if(le(t),le(t),this.isRepeatedInitialValue(t))return void le("Skipping repeated initial value.");const n=[];for(let e=0;e<20;e++)n.push(Math.floor(t[e]/16)),n.push(t[e]%16);le(n);const r=function(e){let t="";return t+=e.slice(0,8).join("."),t+="\n",t+=e.slice(8,16).join("."),t+="\n",t+=e.slice(16,28).join("."),t+="\n",t+=e.slice(28,32).join("."),t+="\n",t+=e.slice(32,40).join("."),t}(n);le(r),this.dispatchMove({latestMove:ze(n[32],n[33]),timeStamp:e.timeStamp,debug:{stateStr:r},state:this.toReid333(t)})}))}isRepeatedInitialValue(e){if(void 0===this.originalValue)throw new Error("GiiKERCube has uninitialized original value.");if(null===this.originalValue)return!1;const t=this.originalValue;this.originalValue=null,le("Comparing against original value.");for(let n=0;n<18;n++)if(t[n]!==e[n])return le("Different at index ",n),!1;return!0}}const Ze="6e400001-b5a3-f393-e0a9-e50e24dcca9e",He="6e400003-b5a3-f393-e0a9-e50e24dcca9e",Ye={filters:[{namePrefix:"GoCube"}],optionalServices:[Ze]};function Je(e){return Array.prototype.map.call(new Uint8Array(e),e=>("00"+e.toString(16)).slice(-2)).join("")}const Xe=[c("B",1),c("B",-1),c("F",1),c("F",-1),c("U",1),c("U",-1),c("D",1),c("D",-1),c("R",1),c("R",-1),c("L",1),c("L",-1)];class GoCube extends BluetoothPuzzle{constructor(e,n){super(),this.server=e,this.goCubeStateCharacteristic=n,this.recorded=[],this.homeQuatInverse=null,this.lastRawQuat=new t.Quaternion(0,0,0,1),this.currentQuat=new t.Quaternion(0,0,0,1),this.lastTarget=new t.Quaternion(0,0,0,1),this.alg=new Sequence([])}static connect(e){return Q(this,void 0,void 0,(function*(){const t=yield e.getPrimaryService(Ze);le({service:t});const n=yield t.getCharacteristic(He);le({goCubeStateCharacteristic:n});const r=new GoCube(e,n);return yield n.startNotifications(),n.addEventListener("characteristicvaluechanged",r.onCubeCharacteristicChanged.bind(r)),r}))}reset(){this.resetAlg(),this.resetOrientation()}resetAlg(e){this.alg=e||new Sequence([])}resetOrientation(){this.homeQuatInverse=this.lastRawQuat.clone().inverse(),this.currentQuat=new t.Quaternion(0,0,0,1),this.lastTarget=new t.Quaternion(0,0,0,1)}name(){return this.server.device.name}onCubeCharacteristicChanged(e){const n=e.target.value;if(this.recorded.push([e.timeStamp,Je(n.buffer)]),8===n.byteLength){const t=Xe[n.getUint8(3)];this.alg=new Sequence(this.alg.nestedUnits.concat([t])),this.dispatchMove({latestMove:Xe[n.getUint8(3)],timeStamp:e.timeStamp,debug:{stateStr:Je(n.buffer)}})}else{const r=function(e){const t=new Uint8Array(e);let n="";for(const e of t)n+=String.fromCharCode(e);return n}(n.buffer.slice(3,n.byteLength-3)).split("#").map(e=>parseInt(e,10)/16384),i=new t.Quaternion(r[0],r[1],r[2],r[3]);this.lastRawQuat=i.clone(),this.homeQuatInverse||(this.homeQuatInverse=i.clone().inverse());const o=i.clone().multiply(this.homeQuatInverse.clone());o.y=-o.y,this.lastTarget.slerp(o,.5),this.currentQuat.rotateTowards(this.lastTarget,et);const{x:s,y:a,z:l,w:u}=this.currentQuat;this.dispatchOrientation({quaternion:{x:s,y:a,z:l,w:u},timeStamp:e.timeStamp})}}}const et=.5,tt=J["3x3x3"];class KeyboardPuzzle extends BluetoothPuzzle{constructor(e){super(),this.puzzle=new KPuzzle(tt),e.addEventListener("keydown",this.onKeyDown.bind(this))}name(){return"Keyboard Input"}getState(){return Q(this,void 0,void 0,(function*(){return this.puzzle.state}))}onKeyDown(e){if(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;const t=F(e);t&&(this.puzzle.applyBlockMove(t),this.dispatchMove({latestMove:t,timeStamp:e.timeStamp,state:this.puzzle.state}),e.preventDefault())}}let nt=0;var rt=Object.freeze({__proto__:null,GanCube:GanCube,GiiKERCube:GiiKERCube,giikerMoveToBlockMoveForTesting:ze,GoCube:GoCube,BluetoothPuzzle:BluetoothPuzzle,MoveEvent:class MoveEvent{},KeyboardPuzzle:KeyboardPuzzle,debugKeyboardConnect:function(e=window){return Q(this,void 0,void 0,(function*(){return new KeyboardPuzzle(e)}))},enableDebugLogging:function(e){ae=e},connect:function(e={}){return Q(this,void 0,void 0,(function*(){let t;le("Attempting to pair.");try{let n=e.acceptAllDevices;!n&&nt>=2&&(console.info("The last 2 Bluetooth puzzle connection attempts failed. This time, the Bluetooth prompt will show all possible devices."),n=!0),t=yield navigator.bluetooth.requestDevice(function(e=!1){const t=e?{acceptAllDevices:!0,optionalServices:[]}:{filters:[],optionalServices:[]};for(const n of[Re,Ge,Ye])e||(t.filters=t.filters.concat(n.filters)),t.optionalServices=t.optionalServices.concat(n.optionalServices);return le({requestOptions:t}),t}(n)),nt=0}catch(e){throw nt++,new Error(e)}if(le("Device:",t),void 0===t.gatt)return Promise.reject("Device did not have a GATT server.");const n=yield t.gatt.connect();le("Server:",n);const r=n.device.name||"";return r&&r.startsWith("GAN")?yield GanCube.connect(n):r&&r.startsWith("GoCube")?yield GoCube.connect(n):yield GiiKERCube.connect(n)}))}});e.alg=j,e.bluetooth=rt,e.kpuzzle=re,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=cubing.no-twisty.umd.js.map
